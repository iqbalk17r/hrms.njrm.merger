-- Active: 1766459170620@@192.168.101.62@5432@HRMS.NUSA

-- Generated by the database client.
CREATE TABLE idbu(
    idbu varchar(2) NOT NULL,
    idbuname varchar(20),
    wilayah varchar(10),
    wilayahname varchar(20),
    regional varchar(3),
    regionalname varchar(10),
    island varchar(10),
    islandname varchar(15),
    PRIMARY KEY(idbu)
);

INSERT INTO sc_mst.idbu (idbu,idbuname,wilayah,wilayahname,regional,regionalname,island,islandname) VALUES
	 ('A','NJRM','AA','BANJARMASIN(PUSAT)','AA','KALSEL','AA','KALIMANTAN'),
	 ('B','BANJARBARU (KM 22)','AB','BANJARMASIN','AA','KALSEL','AA','KALIMANTAN'),
	 ('C','KAYU TANGI','AB','BANJARMASIN','AA','KALSEL','AA','KALIMANTAN'),
	 ('D','SHOWROOM (KM 5,5)','AB','BANJARMASIN','AA','KALSEL','AA','KALIMANTAN'),
	 ('E','NUSA','BA','SURABAYA (PUSAT)','AE','JATIM','AC','JAWA'),
	 ('F','DIST. SURABAYA','BB','SURABAYA','AE','JATIM','AC','JAWA'),
	 ('G','DIST. SOLO','BC','DIST. SELATAN','AE','JATENG','AC','JAWA'),
	 ('H','DIST. YOGJA','BC','DIST. SELATAN','AE','JATENG','AC','JAWA'),
	 ('I','DIST. SEMARANG','BD','DIST. UTARA','AE','JATENG','AC','JAWA'),
	 ('J','DIST. PATI','BD','DIST. UTARA','AE','JATENG','AC','JAWA');
INSERT INTO sc_mst.idbu (idbu,idbuname,wilayah,wilayahname,regional,regionalname,island,islandname) VALUES
	 ('K','DIST. PROYEK','BE','PROYEK','AE','JATENG','AC','JAWA'),
	 ('L','PKA','CA','PALANGKA RAYA(PUSAT)','AB','KALTENG','AA','KALIMANTAN'),
	 ('M','PALANGKA RAYA','CB','PALANGKA RAYA','AB','KALTENG','AA','KALIMANTAN'),
	 ('N','PANGKALANBUN','CC','PANGKALAN BUN','AB','KALTENG','AA','KALIMANTAN'),
	 ('O','SAMPIT','CD','SAMPIT','AB','KALTENG','AA','KALIMANTAN'),
	 ('P','ANJ','DA','SAMARINDA','AC','KALTIM','AA','KALIMANTAN'),
	 ('Q','BALIKPAPAN','DB','BALIKPAPAN','AC','KALTIM','AA','KALIMANTAN'),
	 ('R','SAMARINDA','DC','SAMARINDA','AC','KALTIM','AA','KALIMANTAN'),
	 ('S','KANu','EA','MAKASSAR','AD','SULAWESI','AB','SULAWESI'),
	 ('T','MAKASSAR','EB','MAKASSAR','AD','SULAWESI','AB','SULAWESI');


-- sc_mst.lv_m_karyawan source

CREATE OR REPLACE VIEW sc_mst.lv_m_karyawan
AS SELECT x.branch,
    x.nik,
    x.nmlengkap,
    x.callname,
    x.jk,
    x.neglahir,
    x.provlahir,
    x.kotalahir,
    x.tgllahir,
    x.kd_agama,
    x.stswn,
    x.stsfisik,
    x.ketfisik,
    x.noktp,
    x.ktp_seumurhdp,
    x.ktpdikeluarkan,
    x.tgldikeluarkan,
    x.status_pernikahan,
    x.gol_darah,
    x.negktp,
    x.provktp,
    x.kotaktp,
    x.kecktp,
    x.kelktp,
    x.alamatktp,
    x.negtinggal,
    x.provtinggal,
    x.kotatinggal,
    x.kectinggal,
    x.keltinggal,
    x.alamattinggal,
    x.nohp1,
    x.nohp2,
    x.npwp,
    x.tglnpwp,
    x.bag_dept,
    x.subbag_dept,
    x.jabatan,
    x.lvl_jabatan,
    x.grade_golongan,
    x.nik_atasan,
    x.nik_atasan2,
    x.status_ptkp,
    x.besaranptkp,
    x.tglmasukkerja,
    x.tglkeluarkerja,
    x.masakerja,
    x.statuskepegawaian,
    x.kdcabang,
    x.branchaktif,
    x.grouppenggajian,
    x.gajipokok,
    x.gajibpjs,
    x.namabank,
    x.namapemilikrekening,
    x.norek,
    x.tjshift,
    x.idabsen,
    x.email,
    x.email2,
    x.bolehcuti,
    x.sisacuti,
    x.inputdate,
    x.inputby,
    x.updatedate,
    x.updateby,
    x.image,
    x.idmesin,
    x.cardnumber,
    x.status,
    x.tgl_ktp,
    x.costcenter,
    x.tj_tetap,
    x.gajitetap,
    x.gajinaker,
    x.tjlembur,
    x.tjborong,
    x.nokk,
    x.kdwilayahnominal,
    x.nmjabatan,
    x.nmdept,
    x.nmsubdept,
    x.nmlvljabatan,
    x.nmgrade,
    x.nmagama,
    x.namanegara,
    x.nmprovlahir,
    x.nmkotalahir,
    x.nmprovktp,
    x.nmkotaktp,
    x.nmkecktp,
    x.nmdesaktp,
    x.nmprovtinggal,
    x.nmkotatinggal,
    x.nmkectinggal,
    x.nmdesatinggal,
    x.nmatasan1,
    x.nmatasan2,
    x.nmwilayahnominal,
    x.kdwilayah_gp,
    x.kdlvlgp,
    x.tglmasukkerja1,
    x.tglkeluarkerja1,
    x.tgllahir1,
    x.tglptkp,
    x.tglktp1,
    x.tjborong1,
    x.tjshift1,
    x.tjlembur1,
    x.nmcabang,
    x.masakerja1,
    x.tahunmasakerja,
    x.pinjaman,
    x.nmstatus_pernikahan,
    x.nmstatus_ptkp,
    x.nmbank,
    x.kdgradejabatan,
    x.nmgradejabatan,
    x.deviceid,
    x.callplan,
    x.idbu,
    x.idbuname
   FROM ( SELECT a.branch,
            a.nik,
            a.nmlengkap,
            a.callname,
            a.jk,
            a.neglahir,
            a.provlahir,
            a.kotalahir,
            a.tgllahir,
            a.kd_agama,
            a.stswn,
            a.stsfisik,
            a.ketfisik,
            a.noktp,
            a.ktp_seumurhdp,
            a.ktpdikeluarkan,
            a.tgldikeluarkan,
            a.status_pernikahan,
            a.gol_darah,
            a.negktp,
            a.provktp,
            a.kotaktp,
            a.kecktp,
            a.kelktp,
            a.alamatktp,
            a.negtinggal,
            a.provtinggal,
            a.kotatinggal,
            a.kectinggal,
            a.keltinggal,
            a.alamattinggal,
            a.nohp1,
            a.nohp2,
            a.npwp,
            a.tglnpwp,
            a.bag_dept,
            a.subbag_dept,
            a.jabatan,
            a.lvl_jabatan,
            a.grade_golongan,
            a.nik_atasan,
            a.nik_atasan2,
            a.status_ptkp,
            a.besaranptkp,
            a.tglmasukkerja,
            a.tglkeluarkerja,
            a.masakerja,
            a.statuskepegawaian,
            a.kdcabang,
            a.branchaktif,
            a.grouppenggajian,
            a.gajipokok,
            a.gajibpjs,
            a.namabank,
            a.namapemilikrekening,
            a.norek,
            a.tjshift,
            a.idabsen,
            a.email,
            a.email2,
            a.bolehcuti,
            a.sisacuti,
            a.inputdate,
            a.inputby,
            a.updatedate,
            a.updateby,
            a.image,
            a.idmesin,
            a.cardnumber,
            a.status,
            a.tgl_ktp,
            a.costcenter,
            a.tj_tetap,
            a.gajitetap,
            a.gajinaker,
            a.tjlembur,
            a.tjborong,
            a.nokk,
            a.kdwilayahnominal,
            a.kdlvlgp,
            a.kdgradejabatan,
            a.idbu,
            i5.idbuname,
            COALESCE(a.pinjaman, 0::numeric)::numeric(18,2) AS pinjaman,
            b.nmjabatan,
            c.nmdept,
            d.nmsubdept,
            e.nmlvljabatan,
            f.nmgrade,
            g1.nmagama,
            g2.namanegara,
            g3.namaprov AS nmprovlahir,
            g4.namakotakab AS nmkotalahir,
            g6.nmnikah AS nmstatus_pernikahan,
            g7.nmnikah AS nmstatus_ptkp,
            g8.nmbank,
            h1.namaprov AS nmprovktp,
            h2.namakotakab AS nmkotaktp,
            h3.namakec AS nmkecktp,
            h4.namakeldesa AS nmdesaktp,
            i1.namaprov AS nmprovtinggal,
            i2.namakotakab AS nmkotatinggal,
            i3.namakec AS nmkectinggal,
            i4.namakeldesa AS nmdesatinggal,
            f1.nmlengkap AS nmatasan1,
            f2.nmlengkap AS nmatasan2,
            k1.nmwilayahnominal,
            k1.kdwilayah AS kdwilayah_gp,
            k3.nmgradejabatan,
            to_char(a.tglmasukkerja::timestamp with time zone, 'dd-mm-yyyy'::text) AS tglmasukkerja1,
            to_char(a.tglkeluarkerja::timestamp with time zone, 'dd-mm-yyyy'::text) AS tglkeluarkerja1,
            to_char(a.tgllahir::timestamp with time zone, 'dd-mm-yyyy'::text) AS tgllahir1,
            to_char(a.tgldikeluarkan::timestamp with time zone, 'dd-mm-yyyy'::text) AS tglptkp,
            to_char(a.tgl_ktp::timestamp with time zone, 'dd-mm-yyyy'::text) AS tglktp1,
                CASE
                    WHEN a.tjborong = 't'::bpchar THEN 'YA'::text
                    WHEN a.tjborong = 'f'::bpchar OR a.tjborong IS NULL THEN 'TIDAK'::text
                    ELSE NULL::text
                END AS tjborong1,
                CASE
                    WHEN a.tjshift = 't'::bpchar THEN 'YA'::text
                    WHEN a.tjshift = 'f'::bpchar OR a.tjshift IS NULL THEN 'TIDAK'::text
                    ELSE NULL::text
                END AS tjshift1,
                CASE
                    WHEN a.tjlembur = 't'::bpchar THEN 'YA'::text
                    WHEN a.tjlembur = 'f'::bpchar OR a.tjlembur IS NULL THEN 'TIDAK'::text
                    ELSE NULL::text
                END AS tjlembur1,
            k2.desc_cabang AS nmcabang,
            age(a.tglmasukkerja::timestamp with time zone) AS masakerja1,
            floor(date_part('day'::text, now() - a.tglmasukkerja::timestamp without time zone::timestamp with time zone) / 365::double precision) AS tahunmasakerja,
            a.deviceid,
            a.callplan
           FROM sc_mst.karyawan a
             LEFT JOIN sc_mst.departmen c ON a.bag_dept = c.kddept
             LEFT JOIN sc_mst.subdepartmen d ON a.subbag_dept = d.kdsubdept AND a.bag_dept = d.kddept
             LEFT JOIN sc_mst.jabatan b ON a.subbag_dept = b.kdsubdept AND a.bag_dept = b.kddept AND a.jabatan = b.kdjabatan
             LEFT JOIN sc_mst.lvljabatan e ON a.lvl_jabatan = e.kdlvl
             LEFT JOIN sc_mst.jobgrade f ON a.grade_golongan = f.kdgrade
             LEFT JOIN sc_mst.karyawan f1 ON a.nik_atasan = f1.nik
             LEFT JOIN sc_mst.karyawan f2 ON a.nik_atasan2 = f2.nik
             LEFT JOIN sc_mst.agama g1 ON a.kd_agama = g1.kdagama
             LEFT JOIN sc_mst.negara g2 ON a.neglahir = g2.kodenegara
             LEFT JOIN sc_mst.provinsi g3 ON a.provlahir = g3.kodeprov
             LEFT JOIN sc_mst.kotakab g4 ON a.kotalahir = g4.kodekotakab AND g4.kodeprov = g3.kodeprov
             LEFT JOIN sc_mst.negara g5 ON a.negktp = g5.kodenegara
             LEFT JOIN sc_mst.status_nikah g6 ON a.status_pernikahan = g6.kdnikah
             LEFT JOIN sc_mst.status_nikah g7 ON a.status_ptkp = g7.kdnikah
             LEFT JOIN sc_mst.bank g8 ON a.namabank = g8.kdbank
             LEFT JOIN sc_mst.provinsi h1 ON a.provktp = h1.kodeprov
             LEFT JOIN sc_mst.kotakab h2 ON a.kotaktp = h2.kodekotakab AND h2.kodeprov = h1.kodeprov
             LEFT JOIN sc_mst.kec h3 ON a.kecktp = h3.kodekec
             LEFT JOIN sc_mst.keldesa h4 ON a.kelktp = h4.kodekeldesa
             LEFT JOIN sc_mst.provinsi i1 ON a.provtinggal = i1.kodeprov
             LEFT JOIN sc_mst.kotakab i2 ON a.kotatinggal = i2.kodekotakab AND i2.kodeprov = i1.kodeprov
             LEFT JOIN sc_mst.kec i3 ON a.kectinggal = i3.kodekec
             LEFT JOIN sc_mst.keldesa i4 ON a.keltinggal = i4.kodekeldesa
             LEFT JOIN sc_mst.m_wilayah_nominal k1 ON a.kdwilayahnominal = k1.kdwilayahnominal
             LEFT JOIN sc_mst.kantorwilayah k2 ON k2.kdcabang = a.kdcabang
             LEFT JOIN sc_mst.m_grade_jabatan k3 ON k3.kdgradejabatan = a.kdgradejabatan
             LEFT JOIN sc_mst.idbu i5 ON a.idbu::text = i5.idbu::text) x;

select idbuname,* from sc_mst.lv_m_karyawan
--=======-=============-======

CREATE OR REPLACE FUNCTION sc_tmp.pr_nipnbi_after()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    vr_nik_final    VARCHAR(30);
    vr_prefix       VARCHAR(20);
    vr_partid       VARCHAR(10);
    vr_dokumen      VARCHAR(20);
    vr_nomor        TEXT;
    v_exists        INTEGER;
	v_error_msg     TEXT;
    vr_kdcabang     VARCHAR(20);
BEGIN
    DELETE FROM sc_mst.trxerror WHERE userid = NEW.nik;

    --vr_kdcabang:=trim(coalesce(kdcabang,'')) from sc_tmp.karyawan where nik=new.nik;

    BEGIN
        IF (NEW.tjborong = 't') THEN
            -- BORONG: tetap global
            vr_prefix  := TO_CHAR(NEW.tglmasukkerja, 'YY');
            vr_dokumen := 'NIP-BORONG';
            vr_partid  := '';
        ELSE
            -- PEGAWAI BIASA: per cabang
            vr_prefix  := TRIM(NEW.kdcabang) || '.' || TO_CHAR(NEW.tglmasukkerja, 'MMYY') || '.';
            vr_dokumen := 'NIP-PEGAWAI';
            vr_partid  := TRIM(NEW.idbu);

            IF(NEW.idbu = 'G' OR new.idbu = 'H' ) THEN
                vr_partid  := 'GH';
            END IF;

        END IF;

         vr_kdcabang:=trim(coalesce(kdcabang,'')) from sc_tmp.karyawan where nik=new.nik;

        -- KHUSUS PEGAWAI BIASA: Auto create setting di sc_mst.nomor jika belum ada
        IF (NEW.tjborong = 'f') THEN
            SELECT COUNT(*) INTO v_exists
            FROM sc_mst.nomor
            WHERE dokumen = vr_dokumen
              AND part = vr_partid;

            IF v_exists = 0 THEN
                INSERT INTO sc_mst.nomor (dokumen, part, docno, prefix, sufix, count3)
                VALUES (vr_dokumen, vr_partid, 0, '', '', 3);  -- mulai dari 0 → jadi 001
            END IF;

        END IF;

        DELETE FROM sc_mst.penomoran WHERE userid = NEW.nik;

        -- Insert ke penomoran → trigger pr_beri_nomor_after akan generate
        INSERT INTO sc_mst.penomoran (
            userid, dokumen, nomor, errorid, partid, counterid, xno
        ) VALUES (
            NEW.nik, vr_dokumen, ' ', 0, vr_partid, 1, 0
        );

        SELECT TRIM(nomor)
        INTO vr_nomor
        FROM sc_mst.penomoran
        WHERE userid = NEW.nik;

        IF vr_nomor IS NULL OR TRIM(vr_nomor) = '' THEN
            RAISE EXCEPTION 'Gagal generate nomor untuk dokumen=% partid=%', vr_dokumen, vr_partid;
        END IF;

        -- Format NIK akhir
        IF (NEW.tjborong = 't') THEN
            vr_nik_final := vr_prefix || vr_nomor;
        ELSE
            vr_nik_final := vr_prefix || vr_nomor;  -- sudah 3 digit dari trigger (001, 002, dst.)
        END IF;

        -- Insert ke master karyawan
        INSERT INTO sc_mst.karyawan (
            branch, nik, nmlengkap, callname, jk, neglahir, provlahir, kotalahir, tgllahir, kd_agama,
            stswn, stsfisik, ketfisik, noktp, ktp_seumurhdp, ktpdikeluarkan, tgldikeluarkan,
            status_pernikahan, gol_darah, negktp, provktp, kotaktp, kecktp, kelktp, alamatktp,
            negtinggal, provtinggal, kotatinggal, kectinggal, keltinggal, alamattinggal,
            nohp1, nohp2, npwp, tglnpwp, bag_dept, subbag_dept, jabatan, lvl_jabatan,
            grade_golongan, nik_atasan, nik_atasan2, status_ptkp, besaranptkp,
            tglmasukkerja, tglkeluarkerja, masakerja, statuskepegawaian, kdcabang,
            branchaktif, grouppenggajian, gajipokok, gajibpjs, namabank, namapemilikrekening,
            norek, tjshift, idabsen, email, bolehcuti, sisacuti, inputdate, inputby,
            updatedate, updateby, image, idmesin, cardnumber, status, tgl_ktp, costcenter,
            tj_tetap, gajitetap, gajinaker, tjlembur, tjborong, nokk, kdwilayahnominal,
            kdlvlgp, pinjaman, kdgradejabatan, deviceid, callplan, idbu
        )
        SELECT
            branch, vr_nik_final, nmlengkap, callname, jk, neglahir, provlahir, kotalahir, tgllahir, kd_agama,
            stswn, stsfisik, ketfisik, noktp, ktp_seumurhdp, ktpdikeluarkan, tgldikeluarkan,
            status_pernikahan, gol_darah, negktp, provktp, kotaktp, kecktp, kelktp, alamatktp,
            negtinggal, provtinggal, kotatinggal, kectinggal, keltinggal, alamattinggal,
            nohp1, nohp2, npwp, tglnpwp, bag_dept, subbag_dept, jabatan, lvl_jabatan,
            grade_golongan, nik_atasan, nik_atasan2, status_ptkp, besaranptkp,
            tglmasukkerja, tglkeluarkerja, masakerja, statuskepegawaian, kdcabang,
            branchaktif, grouppenggajian, gajipokok, gajibpjs, namabank, namapemilikrekening,
            norek, tjshift, idabsen, email, bolehcuti, sisacuti, inputdate, inputby,
            updatedate, updateby, image, idmesin, cardnumber, status, tgl_ktp, costcenter,
            tj_tetap, gajitetap, gajinaker, tjlembur, tjborong, nokk, kdwilayahnominal,
            kdlvlgp, pinjaman, kdgradejabatan, deviceid, callplan, idbu
        FROM sc_tmp.karyawan
        WHERE nik = NEW.nik;

        DELETE FROM sc_tmp.karyawan WHERE nik = NEW.nik;

        -- Log sukses
        INSERT INTO sc_mst.trxerror (
            userid, errorcode, nomorakhir1, nomorakhir2, modul, error_detail
        ) VALUES (
            NEW.nik, '0', vr_nomor, vr_nik_final, 'KARYAWAN',
            jsonb_build_object(
                'timestamp', CURRENT_TIMESTAMP,
                'status', 'success',
                'message', 'NIK berhasil digenerate (auto create counter per cabang)',
                'nik', vr_nik_final,
                'nomor_urut', vr_nomor,
                'kdcabang', NEW.kdcabang
            )
        );

    EXCEPTION WHEN OTHERS THEN
        GET STACKED DIAGNOSTICS v_error_msg = MESSAGE_TEXT;

        INSERT INTO sc_mst.trxerror (
            userid, errorcode, nomorakhir1, nomorakhir2, modul, error_detail
        ) VALUES (
            NEW.nik, '1', 'ERROR', '',
            'KARYAWAN',
            jsonb_build_object(
                'timestamp', CURRENT_TIMESTAMP,
                'status', 'error',
                'message', COALESCE(v_error_msg, 'Unknown error'),
                'dokumen', vr_dokumen,
                'partid', vr_partid
            )
        );

        RAISE;
    END;

    RETURN NEW;
END;
$function$;

alter table sc_mst.kantorwilayah 
add column idbu varchar(2)

alter table sc_tmp.karyawan
add column idbu varchar(2)


CREATE OR REPLACE FUNCTION sc_tmp.pr_lembur_after()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
declare
     
     vr_nomor   char(30);
     vr_partid  VARCHAR(10);
     vr_prefix       VARCHAR(20);
     vr_dokumen VARCHAR(20);
     v_exists   INTEGER;
     
begin

select idbu from sc_mst.karyawan where nik=new.nik into vr_partid;
vr_dokumen := 'LEMBUR';
vr_prefix  := 'LBR' || TRIM(vr_partid);

SELECT COUNT(*) INTO v_exists
FROM sc_mst.nomor
WHERE dokumen = vr_dokumen
    AND part = vr_partid;

        IF v_exists = 0 THEN
            INSERT INTO sc_mst.nomor (dokumen, part, docno, prefix, sufix, count3)
            VALUES (vr_dokumen, vr_partid, 0, vr_prefix, '', 8); 
        END IF;

delete from sc_mst.penomoran where userid=new.nodok; 
insert into sc_mst.penomoran 
        (userid,dokumen,nomor,errorid,partid,counterid,xno)
        values(new.nodok,vr_dokumen,' ',0,vr_partid,1,0);

vr_nomor:=trim(coalesce(nomor,'')) from sc_mst.penomoran where userid=new.nodok;
 if (trim(vr_nomor)!='') or (not vr_nomor is null) then
	INSERT INTO sc_trx.lembur(
		nodok,nik,kddept,kdsubdept,kdlvljabatan,kdjabatan,tgl_dok,tgl_kerja,kdlembur,tgl_jam_mulai,tgl_jam_selesai,
		durasi,keterangan,input_by,update_by,nmatasan,kdtrx,nmatasan2,
		input_date,update_date,status,approval_date,approval_by,delete_by,delete_date,cancel_by,cancel_date,durasi_istirahat,jenis_lembur
	    )
	SELECT vr_nomor,nik,kddept,kdsubdept,kdlvljabatan,kdjabatan,tgl_dok,tgl_kerja,kdlembur,tgl_jam_mulai,tgl_jam_selesai,
		durasi,keterangan,input_by,update_by,nmatasan,kdtrx,nmatasan2,
		input_date,update_date,'I' as status,approval_date,approval_by,delete_by,delete_date,cancel_by,cancel_date,durasi_istirahat,jenis_lembur

	from sc_tmp.lembur where nodok=new.nodok and nik=new.nik;
       
delete from sc_tmp.lembur where nodok=new.nodok and nik=new.nik;

end if;

return new;

end;
$function$


CREATE OR REPLACE FUNCTION sc_tmp.pr_cuti_karyawan_after()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
declare
     
     vr_nomor char(30);
     
begin
/*
	Update 30/01/2020 Penambahan notifikasi approval mobile 
*/
--vr_status:=trim(coalesce(status,'')) from sc_tmp.cuti where branch=new.branch and kddokumen=new.kddokumen for update;
--vr_nomor

delete from sc_mst.penomoran where userid=new.nodok; 
insert into sc_mst.penomoran 
        (userid,dokumen,nomor,errorid,partid,counterid,xno)
        values(new.nodok,'CUTI-KARYAWAN',' ',0,' ',1,0);

vr_nomor:=trim(coalesce(nomor,'')) from sc_mst.penomoran where userid=new.nodok;
 if (trim(vr_nomor)!='') or (not vr_nomor is null) then
	INSERT INTO sc_trx.cuti_karyawan(
		nodok,nik,kddept,kdsubdept,kdlvljabatan,kdjabatan,tgl_dok,tpcuti,tgl_mulai,tgl_selesai,kdijin_khusus,
		jumlah_cuti,keterangan,input_by,update_by,nmatasan,pelimpahan,alamat,
		input_date,update_date,status,approval_date,approval_by,delete_by,delete_date,cancel_by,cancel_date,status_ptg
	    )
	SELECT vr_nomor,nik,kddept,kdsubdept,kdlvljabatan,kdjabatan,tgl_dok,tpcuti,tgl_mulai,tgl_selesai,kdijin_khusus,
		jumlah_cuti,keterangan,input_by,update_by,nmatasan,pelimpahan,alamat,
		input_date,update_date,'I' as status,approval_date,approval_by,delete_by,delete_date,cancel_by,cancel_date,status_ptg

	from sc_tmp.cuti_karyawan where nodok=new.nodok and nik=new.nik;
	
	delete from sc_mst.trxerror where modul='CUTI' and userid=new.nodok;
	insert into sc_mst.trxerror
	(userid,errorcode,nomorakhir1,nomorakhir2,modul) VALUES
	(new.nodok,0,vr_nomor,'','CUTI');
       
delete from sc_tmp.cuti_karyawan where nodok=new.nodok and nik=new.nik;

end if;

return new;

end;
$function$



CREATE OR REPLACE FUNCTION sc_tmp.tr_dinas_after()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
declare
     
     vr_nomor char(30);
     vr_partid  VARCHAR(10);
     vr_prefix       VARCHAR(20);
     vr_dokumen VARCHAR(20);
     v_exists   INTEGER;
     
begin

select idbu from sc_mst.karyawan where nik=new.nik into vr_partid;
vr_dokumen := 'DINAS-LUAR';
vr_prefix  := 'DL' || TRIM(vr_partid);

SELECT COUNT(*) INTO v_exists
FROM sc_mst.nomor
WHERE dokumen = vr_dokumen
    AND part = vr_partid;

        IF v_exists = 0 THEN
            INSERT INTO sc_mst.nomor (dokumen, part, docno, prefix, sufix, count3)
            VALUES (vr_dokumen, vr_partid, 0, vr_prefix, '', 9); 
        END IF;

delete from sc_mst.penomoran where userid=new.nodok; 
insert into sc_mst.penomoran 
        (userid,dokumen,nomor,errorid,partid,counterid,xno)
        values(new.nodok,vr_dokumen,' ',0,vr_partid,1,0);
      
vr_nomor:=trim(coalesce(nomor,'')) from sc_mst.penomoran where userid=new.nodok;
 if (trim(vr_nomor)!='') or (not vr_nomor is null) then
	INSERT INTO sc_trx.dinas(
		nik,nodok,tgl_dok,nmatasan,tgl_mulai,tgl_selesai,status,keperluan,tujuan,input_date,input_by,approval_date,approval_by,delete_date,delete_by,update_by,update_date,cancel_by,cancel_date
	    )
	SELECT nik,vr_nomor,tgl_dok,nmatasan,tgl_mulai,tgl_selesai,'I' as status,keperluan,tujuan,input_date,input_by,approval_date,approval_by,delete_date,delete_by,update_by,update_date,cancel_by,cancel_date
	from sc_tmp.dinas where nodok=new.nodok and nik=new.nik;
       
delete from sc_tmp.dinas where nodok=new.nodok and nik=new.nik;

end if;

return new;

end;
$function$

select * from sc_mst.nomor where dokumen = 'DINAS-LUAR'



CREATE OR REPLACE FUNCTION sc_tmp.tr_dinas_tmp_after()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
declare
    vr_nomor char(30);
    vr_partid  VARCHAR(10);
    vr_prefix  VARCHAR(20);
    vr_dokumen VARCHAR(20);
begin
    if (new.status='F' and old.status='I') then
        delete from sc_mst.penomoran where userid=new.nodok;

        select idbu from sc_mst.karyawan where nik=new.nik into vr_partid;
        vr_dokumen := 'DINAS-LUAR';
        vr_prefix  := 'DL' || TRIM(vr_partid);

        insert into sc_mst.penomoran 
        (userid,dokumen,nomor,errorid,partid,counterid,xno)
        values(new.nodok,vr_dokumen,' ',0,vr_partid,1,0);

        vr_nomor:=trim(coalesce(nomor,'')) from sc_mst.penomoran where userid=new.nodok;
   

        if (trim(vr_nomor)!='') or (not vr_nomor is null) then
            INSERT INTO sc_trx.dinas (
                nik,
                nodok,
                tgl_dok,
                nmatasan,
                tgl_mulai,
                jam_mulai,
                tgl_selesai,
                jam_selesai,
                status,
                keperluan,
                callplan,
                tujuan_kota,
                input_date,
                input_by,
                approval_date,
                approval_by,
                delete_date,
                delete_by,
                update_by,
                update_date,
                cancel_by,
                cancel_date,
                kdkategori,
                transportasi,
                tipe_transportasi,
                jenis_tujuan,
                no_telp
            ) SELECT
                  nik,
                  vr_nomor,
                  tgl_dok,
                  nmatasan,
                  tgl_mulai,
                  jam_mulai,
                  tgl_selesai,
                  jam_selesai,
                  old.status as status,
                  keperluan,
                  callplan,
                  tujuan_kota,
                  input_date,
                  input_by,
                  approval_date,
                  approval_by,
                  delete_date,
                  delete_by,
                  update_by,
                  update_date,
                  cancel_by,
                  cancel_date,
                  kdkategori,
                  transportasi,
                  tipe_transportasi,
                  jenis_tujuan,
                  no_telp
            from sc_tmp.dinas where TRUE
                                AND nodok = new.nodok
                                and nik = new.nik
                                and old.status = 'I';

            delete from sc_tmp.dinas where TRUE
                                       AND nodok = new.nodok
                                       and nik = new.nik
                                       and old.status = 'I';
        end if;
    end if;


    IF ( NEW.status = 'U' and OLD.status <> 'U' ) THEN
        DELETE FROM sc_trx.dinas WHERE TRUE
                                   AND nik = NEW.nik
                                   AND nodok = NEW.nodok;

        INSERT INTO sc_trx.dinas (
            nik,
            nodok,
            tgl_dok,
            nmatasan,
            tgl_mulai,
            jam_mulai,
            tgl_selesai,
            jam_selesai,
            status,
            keperluan,
            callplan,
            tujuan_kota,
            input_date,
            input_by,
            approval_date,
            approval_by,
            delete_date,
            delete_by,
            update_by,
            update_date,
            cancel_by,
            cancel_date,
            kdkategori,
            transportasi,
            tipe_transportasi,
            jenis_tujuan,
            no_telp
        ) SELECT
              nik,
              nodok,
              tgl_dok,
              nmatasan,
              tgl_mulai,
              jam_mulai,
              tgl_selesai,
              jam_selesai,
              OLD.status AS status,
              keperluan,
              callplan,
              tujuan_kota,
              input_date,
              input_by,
              approval_date,
              approval_by,
              delete_date,
              delete_by,
              update_by,
              update_date,
              cancel_by,
              cancel_date,
              kdkategori,
              transportasi,
              tipe_transportasi,
              jenis_tujuan,
              no_telp
        FROM sc_tmp.dinas WHERE TRUE
                            AND nik = NEW.nik
                            AND nodok = NEW.nodok;

        DELETE FROM sc_tmp.dinas WHERE TRUE
                                   AND nik = NEW.nik
                                   AND nodok = NEW.nodok;
    END IF;

    /*EX: extend/ perpanjang*/
    IF ( NEW.status = 'EX' and OLD.status <> 'EX' ) THEN
        DELETE FROM sc_trx.dinas WHERE TRUE
                                   AND nik = NEW.nik
                                   AND nodok = NEW.nodok;

        INSERT INTO sc_trx.dinas (
            nik,
            nodok,
            tgl_dok,
            nmatasan,
            tgl_mulai,
            jam_mulai,
            tgl_selesai,
            jam_selesai,
            status,
            keperluan,
            callplan,
            tujuan_kota,
            input_date,
            input_by,
            approval_date,
            approval_by,
            delete_date,
            delete_by,
            update_by,
            update_date,
            cancel_by,
            cancel_date,
            kdkategori,
            transportasi,
            tipe_transportasi,
            jenis_tujuan,
            no_telp
        ) SELECT
              nik,
              nodok,
              tgl_dok,
              nmatasan,
              tgl_mulai,
              jam_mulai,
              tgl_selesai,
              jam_selesai,
              'A' AS status,
              keperluan,
              callplan,
              tujuan_kota,
              input_date,
              input_by,
              approval_date,
              approval_by,
              delete_date,
              delete_by,
              update_by,
              update_date,
              cancel_by,
              cancel_date,
              kdkategori,
              transportasi,
              tipe_transportasi,
              jenis_tujuan,
              no_telp
        FROM sc_tmp.dinas WHERE TRUE
                            AND nik = NEW.nik
                            AND nodok = NEW.nodok;

        DELETE FROM sc_tmp.dinas WHERE TRUE
                                   AND nik = NEW.nik
                                   AND nodok = NEW.nodok;
    END IF;

    IF ( NEW.status = 'A' and OLD.status <> 'A' ) THEN
        perform sc_trx.pr_capture_approvals_system();
    end if;

    RETURN NEW;
end;
$function$


alter table sc_mst.departmen
add column hold varchar(2) default 'N'

alter table sc_mst.subdepartmen
add column hold varchar(2) default 'N'

alter table sc_mst.jabatan
add column hold varchar(2) default 'N'

alter table sc_mst.lvljabatan
add column hold varchar(2) default 'N'


CREATE OR REPLACE FUNCTION sc_tmp.pr_ijin_after()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
declare

    vr_nomor char(30);
    vr_partid  VARCHAR(10);
    vr_prefix       VARCHAR(20);
    vr_dokumen VARCHAR(20);
    v_exists   INTEGER;

begin
select idbu from sc_mst.karyawan where nik=new.nik into vr_partid;
vr_dokumen := 'IJIN-KARYAWAN';
vr_prefix  := 'IK' || TRIM(vr_partid);

SELECT COUNT(*) INTO v_exists
FROM sc_mst.nomor
WHERE dokumen = vr_dokumen
    AND part = vr_partid;

        IF v_exists = 0 THEN
            INSERT INTO sc_mst.nomor (dokumen, part, docno, prefix, sufix, count3)
            VALUES (vr_dokumen, vr_partid, 0, vr_prefix, '', 9); 
        END IF;

    delete from sc_mst.penomoran where userid=new.nodok; 
    insert into sc_mst.penomoran 
    (userid,dokumen,nomor,errorid,partid,counterid,xno)
    values(new.nodok,vr_dokumen,' ',0,vr_partid,1,0);

    vr_nomor:=trim(coalesce(nomor,'')) from sc_mst.penomoran where userid=new.nodok;
    if (trim(vr_nomor)!='') or (not vr_nomor is null) then
        INSERT INTO sc_trx.ijin_karyawan(
            nodok,nik,kddept,kdsubdept,kdlvljabatan,kdjabatan,tgl_dok,tgl_kerja,kdijin_absensi,tgl_jam_mulai,tgl_jam_selesai,
            durasi,keterangan,input_by,update_by,nmatasan,
            input_date,update_date,status,approval_date,approval_by,delete_by,delete_date,cancel_by,cancel_date,type_ijin,kendaraan,nopol,nikpengikut,tgl_mulai, tgl_selesai
        )
        SELECT vr_nomor,nik,kddept,kdsubdept,kdlvljabatan,kdjabatan,tgl_dok,tgl_kerja,kdijin_absensi,tgl_jam_mulai,tgl_jam_selesai,
               durasi,keterangan,input_by,update_by,nmatasan,
               input_date,update_date,'I' as status,approval_date,approval_by,delete_by,delete_date,cancel_by,cancel_date,type_ijin,kendaraan,nopol,nikpengikut,tgl_mulai, tgl_selesai

        from sc_tmp.ijin_karyawan where nodok=new.nodok and nik=new.nik;

        delete from sc_tmp.ijin_karyawan where nodok=new.nodok and nik=new.nik;

    end if;

    return new;

end;
$function$


select * from sc_mst.nomor where dokumen='IJIN-KARYAWAN'



-- DROP FUNCTION sc_tmp.tr_bbmkendaraan_mst();

CREATE OR REPLACE FUNCTION sc_tmp.tr_bbmkendaraan_mst()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    --created by Fiky ::18/05/2018
     vr_nomor CHAR(12);
    
BEGIN
	IF TG_OP = 'INSERT' THEN

	    RETURN NEW;
	ELSEIF TG_OP = 'UPDATE' THEN
		IF(new.status = 'F' AND old.status = 'I') THEN
			DELETE FROM sc_mst.penomoran WHERE userid = new.docno;
			DELETE FROM sc_mst.trxerror WHERE userid = new.docno;

			
			insert into sc_mst.penomoran (userid, dokumen,nomor,errorid,partid,counterid,xno)
			values (new.docno, 'BA_BK', ' ', 0, ' ', 1, 0);

            vr_nomor := TRIM(COALESCE(nomor, '')) FROM sc_mst.penomoran WHERE userid = new.docno AND dokumen = 'BA_BK';

			INSERT INTO sc_his.bbmkendaraan_mst
            (docno, docdate, docref, kdgroup, kdsubgroup, stockcode, bahanbakar, km_awal, km_akhir, ttlvalue, description, status,
            inputdate, inputby, updatedate, updateby, approvaldate, approvalby, docnotmp, suppcode, subsuppcode, kupon, liters, printyes, printby, printdate, hargasatuan)
            (SELECT vr_nomor, docdate, docref, kdgroup, kdsubgroup, stockcode, bahanbakar, km_awal, km_akhir, ttlvalue, description, 'A' AS status,
            inputdate, inputby, updatedate, updateby, approvaldate, approvalby, docnotmp, suppcode, subsuppcode, kupon, liters, printyes, printby, printdate, hargasatuan FROM sc_tmp.bbmkendaraan_mst WHERE docno = new.docno);

			DELETE FROM sc_tmp.bbmkendaraan_mst WHERE docno = new.docno;
		ELSEIF(new.status = 'F' AND old.status = 'E') THEN
			DELETE FROM sc_his.bbmkendaraan_mst WHERE docno = new.docnotmp;

			INSERT INTO sc_his.bbmkendaraan_mst
            (docno, docdate, docref, kdgroup, kdsubgroup, stockcode, bahanbakar, km_awal, km_akhir, ttlvalue, description, status,
            inputdate, inputby, updatedate, updateby, approvaldate, approvalby, docnotmp, suppcode, subsuppcode, kupon, liters, printyes, printby, printdate, hargasatuan)
            (SELECT docnotmp, docdate, docref, kdgroup, kdsubgroup, stockcode, bahanbakar, km_awal, km_akhir, ttlvalue, description, 'A' AS status,
            inputdate, inputby, updatedate, updateby, approvaldate, approvalby, docnotmp, suppcode, subsuppcode, kupon, liters, printyes, printby, printdate, hargasatuan FROM sc_tmp.bbmkendaraan_mst WHERE docno = new.docno);

			DELETE FROM sc_tmp.bbmkendaraan_mst WHERE docno = new.docno;
		ELSEIF(new.status = 'F' AND old.status = 'A') THEN
			DELETE FROM sc_his.bbmkendaraan_mst WHERE docno = new.docnotmp;

			INSERT INTO sc_his.bbmkendaraan_mst
            (docno, docdate, docref, kdgroup, kdsubgroup, stockcode, bahanbakar, km_awal, km_akhir, ttlvalue, description, status,
            inputdate, inputby, updatedate, updateby, approvaldate, approvalby, docnotmp, suppcode, subsuppcode, kupon, liters, printyes, printby, printdate, hargasatuan)
            (SELECT docnotmp, docdate, docref, kdgroup, kdsubgroup, stockcode, bahanbakar, km_awal, km_akhir, ttlvalue, description, 'P' AS status,
            inputdate, inputby, updatedate, updateby, approvaldate, approvalby, docnotmp, suppcode, subsuppcode, kupon, liters, printyes, printby, printdate, hargasatuan FROM sc_tmp.bbmkendaraan_mst WHERE docno = new.docno);

			update sc_mst.mbarang set lastkmh=new.km_akhir where nodok=new.stockcode;

			DELETE FROM sc_tmp.bbmkendaraan_mst WHERE docno = new.docno;
		ELSEIF(new.status = 'F' AND old.status = 'C') THEN
			DELETE FROM sc_his.bbmkendaraan_mst WHERE docno = new.docnotmp;

			INSERT INTO sc_his.bbmkendaraan_mst
            (docno, docdate, docref, kdgroup, kdsubgroup, stockcode, bahanbakar, km_awal, km_akhir, ttlvalue, description, status,
            inputdate, inputby, updatedate, updateby, approvaldate, approvalby, docnotmp, suppcode, subsuppcode, kupon, liters, printyes, printby, printdate, hargasatuan)
            (SELECT docnotmp, docdate, docref, kdgroup, kdsubgroup, stockcode, bahanbakar, km_awal, km_akhir, ttlvalue, description, 'C' AS status,
            inputdate, inputby, updatedate, updateby, approvaldate, approvalby, docnotmp, suppcode, subsuppcode, kupon, liters, printyes, printby, printdate, hargasatuan FROM sc_tmp.bbmkendaraan_mst WHERE docno = new.docno);

			DELETE FROM sc_tmp.bbmkendaraan_mst WHERE docno = new.docno;
		END IF;

	    RETURN NEW;
	END IF;

    RETURN new;
END;
$function$
;


---========== drop view karyawan ================----------
ALTER TABLE sc_tmp.karyawan
ALTER COLUMN nik TYPE VARCHAR(20);

ALTER TABLE sc_mst.karyawan
ALTER COLUMN nik TYPE VARCHAR(20);

drop VIEW sc_mst.lv_m_karyawan
 
drop VIEW sc_trx.v_lembur
  
drop VIEW sc_trx.v_ijin_karyawan

drop VIEW  sc_trx.v_dinas

drop VIEW sc_trx.v_cuti_karyawan

drop view  sc_trx.qv_uangmakan

drop view  sc_tmp.v_pdca_mst

drop view sc_mst.v_dtlgaji_karyawan

drop view  sc_mst.masterkaryawan

drop view sc_his.perawatanspk_view

-- sc_mst.lv_m_karyawan source

CREATE OR REPLACE VIEW sc_mst.lv_m_karyawan
AS SELECT x.branch,
    x.nik,
    x.nmlengkap,
    x.callname,
    x.jk,
    x.neglahir,
    x.provlahir,
    x.kotalahir,
    x.tgllahir,
    x.kd_agama,
    x.stswn,
    x.stsfisik,
    x.ketfisik,
    x.noktp,
    x.ktp_seumurhdp,
    x.ktpdikeluarkan,
    x.tgldikeluarkan,
    x.status_pernikahan,
    x.gol_darah,
    x.negktp,
    x.provktp,
    x.kotaktp,
    x.kecktp,
    x.kelktp,
    x.alamatktp,
    x.negtinggal,
    x.provtinggal,
    x.kotatinggal,
    x.kectinggal,
    x.keltinggal,
    x.alamattinggal,
    x.nohp1,
    x.nohp2,
    x.npwp,
    x.tglnpwp,
    x.bag_dept,
    x.subbag_dept,
    x.jabatan,
    x.lvl_jabatan,
    x.grade_golongan,
    x.nik_atasan,
    x.nik_atasan2,
    x.status_ptkp,
    x.besaranptkp,
    x.tglmasukkerja,
    x.tglkeluarkerja,
    x.masakerja,
    x.statuskepegawaian,
    x.kdcabang,
    x.branchaktif,
    x.grouppenggajian,
    x.gajipokok,
    x.gajibpjs,
    x.namabank,
    x.namapemilikrekening,
    x.norek,
    x.tjshift,
    x.idabsen,
    x.email,
    x.email2,
    x.bolehcuti,
    x.sisacuti,
    x.inputdate,
    x.inputby,
    x.updatedate,
    x.updateby,
    x.image,
    x.idmesin,
    x.cardnumber,
    x.status,
    x.tgl_ktp,
    x.costcenter,
    x.tj_tetap,
    x.gajitetap,
    x.gajinaker,
    x.tjlembur,
    x.tjborong,
    x.nokk,
    x.kdwilayahnominal,
    x.nmjabatan,
    x.nmdept,
    x.nmsubdept,
    x.nmlvljabatan,
    x.nmgrade,
    x.nmagama,
    x.namanegara,
    x.nmprovlahir,
    x.nmkotalahir,
    x.nmprovktp,
    x.nmkotaktp,
    x.nmkecktp,
    x.nmdesaktp,
    x.nmprovtinggal,
    x.nmkotatinggal,
    x.nmkectinggal,
    x.nmdesatinggal,
    x.nmatasan1,
    x.nmatasan2,
    x.nmwilayahnominal,
    x.kdwilayah_gp,
    x.kdlvlgp,
    x.tglmasukkerja1,
    x.tglkeluarkerja1,
    x.tgllahir1,
    x.tglptkp,
    x.tglktp1,
    x.tjborong1,
    x.tjshift1,
    x.tjlembur1,
    x.nmcabang,
    x.masakerja1,
    x.tahunmasakerja,
    x.pinjaman,
    x.nmstatus_pernikahan,
    x.nmstatus_ptkp,
    x.nmbank,
    x.kdgradejabatan,
    x.nmgradejabatan,
    x.deviceid,
    x.callplan,
    x.idbu,
    x.idbuname
   FROM ( SELECT a.branch,
            a.nik,
            a.nmlengkap,
            a.callname,
            a.jk,
            a.neglahir,
            a.provlahir,
            a.kotalahir,
            a.tgllahir,
            a.kd_agama,
            a.stswn,
            a.stsfisik,
            a.ketfisik,
            a.noktp,
            a.ktp_seumurhdp,
            a.ktpdikeluarkan,
            a.tgldikeluarkan,
            a.status_pernikahan,
            a.gol_darah,
            a.negktp,
            a.provktp,
            a.kotaktp,
            a.kecktp,
            a.kelktp,
            a.alamatktp,
            a.negtinggal,
            a.provtinggal,
            a.kotatinggal,
            a.kectinggal,
            a.keltinggal,
            a.alamattinggal,
            a.nohp1,
            a.nohp2,
            a.npwp,
            a.tglnpwp,
            a.bag_dept,
            a.subbag_dept,
            a.jabatan,
            a.lvl_jabatan,
            a.grade_golongan,
            a.nik_atasan,
            a.nik_atasan2,
            a.status_ptkp,
            a.besaranptkp,
            a.tglmasukkerja,
            a.tglkeluarkerja,
            a.masakerja,
            a.statuskepegawaian,
            a.kdcabang,
            a.branchaktif,
            a.grouppenggajian,
            a.gajipokok,
            a.gajibpjs,
            a.namabank,
            a.namapemilikrekening,
            a.norek,
            a.tjshift,
            a.idabsen,
            a.email,
            a.email2,
            a.bolehcuti,
            a.sisacuti,
            a.inputdate,
            a.inputby,
            a.updatedate,
            a.updateby,
            a.image,
            a.idmesin,
            a.cardnumber,
            a.status,
            a.tgl_ktp,
            a.costcenter,
            a.tj_tetap,
            a.gajitetap,
            a.gajinaker,
            a.tjlembur,
            a.tjborong,
            a.nokk,
            a.kdwilayahnominal,
            a.kdlvlgp,
            a.kdgradejabatan,
            a.idbu,
            i5.idbuname,
            COALESCE(a.pinjaman, 0::numeric)::numeric(18,2) AS pinjaman,
            b.nmjabatan,
            c.nmdept,
            d.nmsubdept,
            e.nmlvljabatan,
            f.nmgrade,
            g1.nmagama,
            g2.namanegara,
            g3.namaprov AS nmprovlahir,
            g4.namakotakab AS nmkotalahir,
            g6.nmnikah AS nmstatus_pernikahan,
            g7.nmnikah AS nmstatus_ptkp,
            g8.nmbank,
            h1.namaprov AS nmprovktp,
            h2.namakotakab AS nmkotaktp,
            h3.namakec AS nmkecktp,
            h4.namakeldesa AS nmdesaktp,
            i1.namaprov AS nmprovtinggal,
            i2.namakotakab AS nmkotatinggal,
            i3.namakec AS nmkectinggal,
            i4.namakeldesa AS nmdesatinggal,
            f1.nmlengkap AS nmatasan1,
            f2.nmlengkap AS nmatasan2,
            k1.nmwilayahnominal,
            k1.kdwilayah AS kdwilayah_gp,
            k3.nmgradejabatan,
            to_char(a.tglmasukkerja::timestamp with time zone, 'dd-mm-yyyy'::text) AS tglmasukkerja1,
            to_char(a.tglkeluarkerja::timestamp with time zone, 'dd-mm-yyyy'::text) AS tglkeluarkerja1,
            to_char(a.tgllahir::timestamp with time zone, 'dd-mm-yyyy'::text) AS tgllahir1,
            to_char(a.tgldikeluarkan::timestamp with time zone, 'dd-mm-yyyy'::text) AS tglptkp,
            to_char(a.tgl_ktp::timestamp with time zone, 'dd-mm-yyyy'::text) AS tglktp1,
                CASE
                    WHEN a.tjborong = 't'::bpchar THEN 'YA'::text
                    WHEN a.tjborong = 'f'::bpchar OR a.tjborong IS NULL THEN 'TIDAK'::text
                    ELSE NULL::text
                END AS tjborong1,
                CASE
                    WHEN a.tjshift = 't'::bpchar THEN 'YA'::text
                    WHEN a.tjshift = 'f'::bpchar OR a.tjshift IS NULL THEN 'TIDAK'::text
                    ELSE NULL::text
                END AS tjshift1,
                CASE
                    WHEN a.tjlembur = 't'::bpchar THEN 'YA'::text
                    WHEN a.tjlembur = 'f'::bpchar OR a.tjlembur IS NULL THEN 'TIDAK'::text
                    ELSE NULL::text
                END AS tjlembur1,
            k2.desc_cabang AS nmcabang,
            age(a.tglmasukkerja::timestamp with time zone) AS masakerja1,
            floor(date_part('day'::text, now() - a.tglmasukkerja::timestamp without time zone::timestamp with time zone) / 365::double precision) AS tahunmasakerja,
            a.deviceid,
            a.callplan
           FROM sc_mst.karyawan a
             LEFT JOIN sc_mst.departmen c ON a.bag_dept = c.kddept
             LEFT JOIN sc_mst.subdepartmen d ON a.subbag_dept = d.kdsubdept AND a.bag_dept = d.kddept
             LEFT JOIN sc_mst.jabatan b ON a.subbag_dept = b.kdsubdept AND a.bag_dept = b.kddept AND a.jabatan = b.kdjabatan
             LEFT JOIN sc_mst.lvljabatan e ON a.lvl_jabatan = e.kdlvl
             LEFT JOIN sc_mst.jobgrade f ON a.grade_golongan = f.kdgrade
             LEFT JOIN sc_mst.karyawan f1 ON a.nik_atasan = f1.nik
             LEFT JOIN sc_mst.karyawan f2 ON a.nik_atasan2 = f2.nik
             LEFT JOIN sc_mst.agama g1 ON a.kd_agama = g1.kdagama
             LEFT JOIN sc_mst.negara g2 ON a.neglahir = g2.kodenegara
             LEFT JOIN sc_mst.provinsi g3 ON a.provlahir = g3.kodeprov
             LEFT JOIN sc_mst.kotakab g4 ON a.kotalahir = g4.kodekotakab AND g4.kodeprov = g3.kodeprov
             LEFT JOIN sc_mst.negara g5 ON a.negktp = g5.kodenegara
             LEFT JOIN sc_mst.status_nikah g6 ON a.status_pernikahan = g6.kdnikah
             LEFT JOIN sc_mst.status_nikah g7 ON a.status_ptkp = g7.kdnikah
             LEFT JOIN sc_mst.bank g8 ON a.namabank = g8.kdbank
             LEFT JOIN sc_mst.provinsi h1 ON a.provktp = h1.kodeprov
             LEFT JOIN sc_mst.kotakab h2 ON a.kotaktp = h2.kodekotakab AND h2.kodeprov = h1.kodeprov
             LEFT JOIN sc_mst.kec h3 ON a.kecktp = h3.kodekec
             LEFT JOIN sc_mst.keldesa h4 ON a.kelktp = h4.kodekeldesa
             LEFT JOIN sc_mst.provinsi i1 ON a.provtinggal = i1.kodeprov
             LEFT JOIN sc_mst.kotakab i2 ON a.kotatinggal = i2.kodekotakab AND i2.kodeprov = i1.kodeprov
             LEFT JOIN sc_mst.kec i3 ON a.kectinggal = i3.kodekec
             LEFT JOIN sc_mst.keldesa i4 ON a.keltinggal = i4.kodekeldesa
             LEFT JOIN sc_mst.m_wilayah_nominal k1 ON a.kdwilayahnominal = k1.kdwilayahnominal
             LEFT JOIN sc_mst.kantorwilayah k2 ON k2.kdcabang = a.kdcabang
             LEFT JOIN sc_mst.m_grade_jabatan k3 ON k3.kdgradejabatan = a.kdgradejabatan
             LEFT JOIN sc_mst.idbu i5 ON a.idbu::text = i5.idbu::text) x;





             -- sc_trx.v_lembur source

CREATE OR REPLACE VIEW sc_trx.v_lembur
AS SELECT DISTINCT ON (l.nodok) btrim(l.nik::text) AS nik,
    btrim(l.nodok::text) AS nodok,
    l.tgl_dok,
    l.kdlembur,
    l.kddept,
    l.kdsubdept,
    l.kdjabatan,
    l.kdlvljabatan,
    l.nmatasan,
    l.nmatasan2,
    l.tgl_kerja,
    l.tgl_jam_mulai,
    l.tgl_jam_selesai,
    l.durasi,
    l.status,
    l.kdtrx,
    l.keterangan,
    l.input_date,
    l.approval_date,
    btrim(l.input_by::text) AS input_by,
    l.approval_by,
    l.delete_by,
    l.cancel_by,
    l.update_date,
    l.delete_date,
    l.cancel_date,
    l.update_by,
    l.durasi_istirahat,
    l.jenis_lembur,
    l.properties,
    k.nmlengkap AS nama_karyawan,
    s.nmlengkap AS input_by_name,
    r.nmlengkap AS approval_by_name,
    dp.nmdept AS department_name,
    sdp.nmsubdept AS sub_department_name,
    j.nmjabatan AS position_name,
    COALESCE(trx.uraian, 'Lain - Lain'::character varying) AS kategori_lembur,
        CASE l.status
            WHEN 'A'::bpchar THEN 'needapproval'::text
            WHEN 'C'::bpchar THEN 'canceled'::text
            WHEN 'I'::bpchar THEN 'input'::text
            WHEN 'D'::bpchar THEN 'deletedorexpired'::text
            WHEN 'P'::bpchar THEN 'approvedorprint'::text
            WHEN 'F'::bpchar THEN 'return'::text
            ELSE 'unknown'::text
        END AS status_lembur,
        CASE l.jenis_lembur
            WHEN 'D1'::bpchar THEN 'absenceduration'::text
            WHEN 'D2'::bpchar THEN 'nonabsenceduration'::text
            ELSE 'unknown'::text
        END AS j_lembur,
        CASE l.status
            WHEN 'A'::bpchar THEN '#2196F3'::text
            WHEN 'A1'::bpchar THEN '#536DFE'::text
            WHEN 'A2'::bpchar THEN '#3F51B5'::text
            WHEN 'C'::bpchar THEN '#F44336'::text
            WHEN 'I'::bpchar THEN '#9E9E9E'::text
            WHEN 'D'::bpchar THEN '#000000'::text
            WHEN 'P'::bpchar THEN '#4CAF50'::text
            WHEN 'F'::bpchar THEN '#FF5252'::text
            ELSE '#000000'::text
        END AS status_color
   FROM sc_trx.lembur l
     LEFT JOIN sc_mst.karyawan k ON btrim(l.nik::text) = btrim(k.nik::text)
     LEFT JOIN sc_mst.karyawan s ON btrim(l.input_by::text) = btrim(s.nik::text)
     LEFT JOIN sc_mst.karyawan r ON btrim(l.approval_by::text) = btrim(r.nik::text)
     LEFT JOIN sc_mst.departmen dp ON btrim(l.kddept::text) = btrim(dp.kddept::text)
     LEFT JOIN sc_mst.subdepartmen sdp ON btrim(l.kdsubdept::text) = btrim(sdp.kdsubdept::text)
     LEFT JOIN sc_mst.jabatan j ON btrim(l.kdjabatan::text) = btrim(j.kdjabatan::text)
     LEFT JOIN sc_mst.trxtype trx ON l.kdtrx = trx.kdtrx AND btrim(trx.jenistrx::text) = 'ALASAN LEMBUR'::text;



     -- sc_trx.v_ijin_karyawan source

CREATE OR REPLACE VIEW sc_trx.v_ijin_karyawan
AS SELECT DISTINCT ON (ik.nodok) btrim(ik.nik::text) AS nik,
    btrim(ik.nodok::text) AS nodok,
    ik.tgl_dok,
    ik.kdijin_absensi,
    ik.type_ijin,
    ik.kddept,
    ik.kdsubdept,
    ik.kdjabatan,
    ik.kdlvljabatan,
    ik.nmatasan,
    ik.tgl_kerja,
    ik.tgl_jam_mulai,
    ik.tgl_jam_selesai,
    ik.tgl_mulai,
    ik.tgl_selesai,
    ik.durasi,
    ik.status,
    ik.nopol,
    ik.kendaraan,
    ik.keterangan,
    ik.input_date,
    ik.approval_date,
    btrim(ik.input_by::text) AS input_by,
    ik.approval_by,
    ik.delete_by,
    ik.cancel_by,
    ik.update_date,
    ik.delete_date,
    ik.cancel_date,
    ik.update_by,
    ik.properties,
    k.nmlengkap AS nama_karyawan,
    s.nmlengkap AS input_by_name,
    r.nmlengkap AS approval_by_name,
    dp.nmdept AS department_name,
    sdp.nmsubdept AS sub_department_name,
    j.nmjabatan AS position_name,
    ab.nmijin_absensi AS absence_name,
        CASE ik.status
            WHEN 'A'::bpchar THEN 'needapproval'::text
            WHEN 'A1'::bpchar THEN 'approval1'::text
            WHEN 'A2'::bpchar THEN 'approval2'::text
            WHEN 'C'::bpchar THEN 'canceled'::text
            WHEN 'I'::bpchar THEN 'input'::text
            WHEN 'D'::bpchar THEN 'deletedorexpired'::text
            WHEN 'P'::bpchar THEN 'approvedorprint'::text
            WHEN 'F'::bpchar THEN 'return'::text
            ELSE 'unknown'::text
        END AS status_ijin,
        CASE ik.status
            WHEN 'A'::bpchar THEN '#2196F3'::text
            WHEN 'A1'::bpchar THEN '#536DFE'::text
            WHEN 'A2'::bpchar THEN '#3F51B5'::text
            WHEN 'C'::bpchar THEN '#F44336'::text
            WHEN 'I'::bpchar THEN '#9E9E9E'::text
            WHEN 'D'::bpchar THEN '#000000'::text
            WHEN 'P'::bpchar THEN '#4CAF50'::text
            WHEN 'F'::bpchar THEN '#FF5252'::text
            ELSE '#000000'::text
        END AS status_color,
        CASE ik.type_ijin
            WHEN 'PB'::bpchar THEN 'private'::text
            WHEN 'DN'::bpchar THEN 'duty'::text
            ELSE 'Unknown'::text
        END AS tipe_ijin,
        CASE btrim(ik.kendaraan::text)
            WHEN 'PRIBADI'::bpchar THEN 'private'::text
            WHEN 'DINAS'::bpchar THEN 'duty'::text
            ELSE 'Unknown'::text
        END AS vehicle_type
   FROM sc_trx.ijin_karyawan ik
     LEFT JOIN sc_mst.karyawan k ON btrim(ik.nik::text) = btrim(k.nik::text)
     LEFT JOIN sc_mst.karyawan s ON btrim(ik.input_by::text) = btrim(s.nik::text)
     LEFT JOIN sc_mst.karyawan r ON btrim(ik.approval_by::text) = btrim(r.nik::text)
     LEFT JOIN sc_mst.departmen dp ON btrim(ik.kddept::text) = btrim(dp.kddept::text)
     LEFT JOIN sc_mst.subdepartmen sdp ON btrim(ik.kdsubdept::text) = btrim(sdp.kdsubdept::text)
     LEFT JOIN sc_mst.jabatan j ON btrim(ik.kdjabatan::text) = btrim(j.kdjabatan::text)
     LEFT JOIN sc_mst.ijin_absensi ab ON btrim(ik.kdijin_absensi::text) = btrim(ab.kdijin_absensi::text);


     -- sc_trx.v_dinas source

CREATE OR REPLACE VIEW sc_trx.v_dinas
AS SELECT DISTINCT ON (a.nodok) a.nik,
    a.nodok,
    a.tgl_dok,
    a.tgl_mulai,
    a.tgl_selesai,
    a.jam_mulai,
    a.jam_selesai,
    a.nmatasan,
    a.keperluan,
    a.tujuan_kota,
    a.jenis_tujuan,
    a.transportasi,
    a.tipe_transportasi,
    a.no_telp,
    a.callplan,
    a.kdkategori,
    a.input_date,
    a.approval_date,
    a.input_by,
    a.approval_by,
    a.delete_by,
    a.cancel_by,
    a.update_date,
    a.delete_date,
    a.cancel_date,
    a.update_by,
    a.properties,
    k.nmlengkap AS nama_karyawan,
    s.nmlengkap AS input_by_name,
    r.nmlengkap AS approval_by_name,
    dp.nmdept AS department_name,
    sdp.nmsubdept AS sub_department_name,
    j.nmjabatan AS position_name,
    COALESCE(trx.uraian, 'Lain - Lain'::character varying) AS transportation_name,
    COALESCE(trxtp.uraian, 'Lain - Lain'::character varying) AS type_transportation_name,
    COALESCE(f.description, 'Lain - Lain'::text) AS destination_type_name,
    COALESCE(kt.nmkategori, 'Lain - Lain'::character varying) AS category_name,
        CASE
            WHEN g.destination_text IS NOT NULL AND g.destination_text <> ''::text THEN g.destination_text::character varying
            WHEN kk.namakotakab IS NOT NULL THEN kk.namakotakab::character varying
            ELSE a.tujuan_kota
        END AS namakotakab,
        CASE
            WHEN a.callplan THEN 'YA'::text
            ELSE 'TIDAK'::text
        END AS callplan_display,
        CASE a.status
            WHEN 'A'::text THEN 'needapproval'::text
            WHEN 'A1'::text THEN 'approval1'::text
            WHEN 'A2'::text THEN 'approval2'::text
            WHEN 'C'::text THEN 'canceled'::text
            WHEN 'I'::text THEN 'input'::text
            WHEN 'D'::text THEN 'deletedorexpired'::text
            WHEN 'P'::text THEN 'approvedorprint'::text
            WHEN 'F'::text THEN 'return'::text
            ELSE 'unknown'::text
        END AS status_dinas,
        CASE a.status
            WHEN 'A'::text THEN '#2196F3'::text
            WHEN 'A1'::text THEN '#536DFE'::text
            WHEN 'A2'::text THEN '#3F51B5'::text
            WHEN 'C'::text THEN '#F44336'::text
            WHEN 'I'::text THEN '#9E9E9E'::text
            WHEN 'D'::text THEN '#000000'::text
            WHEN 'P'::text THEN '#4CAF50'::text
            WHEN 'F'::text THEN '#FF5252'::text
            ELSE '#000000'::text
        END AS status_color
   FROM sc_trx.dinas a
     LEFT JOIN sc_mst.karyawan k ON a.nik = k.nik
     LEFT JOIN sc_mst.karyawan s ON a.input_by = s.nik
     LEFT JOIN sc_mst.karyawan r ON a.approval_by = r.nik
     LEFT JOIN sc_mst.trxtype trxtp ON a.tipe_transportasi::bpchar = trxtp.kdtrx AND trxtp.jenistrx::text = 'TRANSPTYPE'::text
     LEFT JOIN sc_mst.trxtype trx ON a.transportasi::bpchar = trx.kdtrx AND trx.jenistrx::text = 'TRANSP'::text
     LEFT JOIN sc_mst.kategori kt ON a.kdkategori = kt.kdkategori AND kt.typekategori::text = 'DINAS'::text
     LEFT JOIN sc_mst.destination_type f ON a.jenis_tujuan::text = f.destinationid::text
     LEFT JOIN sc_mst.departmen dp ON k.bag_dept = dp.kddept
     LEFT JOIN sc_mst.subdepartmen sdp ON k.subbag_dept = sdp.kdsubdept
     LEFT JOIN sc_mst.jabatan j ON k.jabatan = j.kdjabatan
     LEFT JOIN sc_mst.kotakab kk ON a.tujuan_kota::bpchar = kk.kodekotakab
     LEFT JOIN ( SELECT aa.nodok,
            string_agg(aa.namakotakab::text, ', '::text) AS destination_text
           FROM ( SELECT a_1.nodok,
                    b.namakotakab
                   FROM sc_trx.dinas a_1
                     LEFT JOIN sc_mst.kotakab b ON b.kodekotakab::text = ANY (string_to_array(a_1.tujuan_kota::text, ','::text))) aa
          GROUP BY aa.nodok) g ON a.nodok = g.nodok
  ORDER BY a.nodok, a.tgl_dok DESC;

  -- sc_trx.v_cuti_karyawan source

CREATE OR REPLACE VIEW sc_trx.v_cuti_karyawan
AS WITH unique_cuti AS (
         SELECT DISTINCT btrim(cuti_karyawan.nik::text) AS nik,
            btrim(cuti_karyawan.nodok::text) AS nodok,
            cuti_karyawan.tgl_dok,
            cuti_karyawan.tpcuti,
            cuti_karyawan.kdijin_khusus,
            cuti_karyawan.kddept,
            cuti_karyawan.kdsubdept,
            cuti_karyawan.kdjabatan,
            cuti_karyawan.kdlvljabatan,
            cuti_karyawan.nmatasan,
            cuti_karyawan.tgl_mulai,
            cuti_karyawan.tgl_selesai,
            cuti_karyawan.jumlah_cuti,
            btrim(cuti_karyawan.pelimpahan::text) AS pelimpahan,
            cuti_karyawan.alamat,
            cuti_karyawan.status,
            cuti_karyawan.kdtrx,
            cuti_karyawan.keterangan,
            cuti_karyawan.input_date,
            cuti_karyawan.approval_date,
            btrim(cuti_karyawan.input_by::text) AS input_by,
            cuti_karyawan.approval_by,
            cuti_karyawan.delete_by,
            cuti_karyawan.cancel_by,
            cuti_karyawan.update_date,
            cuti_karyawan.delete_date,
            cuti_karyawan.cancel_date,
            cuti_karyawan.update_by,
            cuti_karyawan.status_ptg,
            cuti_karyawan.whatsappsent,
            cuti_karyawan.whatsappaccept,
            cuti_karyawan.whatsappreject,
            cuti_karyawan.retry,
            cuti_karyawan.properties
           FROM sc_trx.cuti_karyawan
        )
 SELECT uc.nik,
    uc.nodok,
    uc.tgl_dok,
    uc.tpcuti,
    uc.kdijin_khusus,
    uc.kddept,
    uc.kdsubdept,
    uc.kdjabatan,
    uc.kdlvljabatan,
    uc.nmatasan,
    uc.tgl_mulai,
    uc.tgl_selesai,
    uc.jumlah_cuti,
    uc.pelimpahan,
    uc.alamat,
    uc.status,
    uc.kdtrx,
    uc.keterangan,
    uc.input_date,
    uc.approval_date,
    uc.input_by,
    uc.approval_by,
    uc.delete_by,
    uc.cancel_by,
    uc.update_date,
    uc.delete_date,
    uc.cancel_date,
    uc.update_by,
    uc.status_ptg,
    uc.whatsappsent,
    uc.whatsappaccept,
    uc.whatsappreject,
    uc.retry,
    uc.properties,
    k.nmlengkap AS nama_karyawan,
    d.nmlengkap AS nama_pelimpahan,
    s.nmlengkap AS input_by_name,
    r.nmlengkap AS approval_by_name,
    ik.nmijin_khusus AS special_leave_name,
    dp.nmdept AS department_name,
    sdp.nmsubdept AS sub_department_name,
    j.nmjabatan AS position_name,
        CASE
            WHEN uc.status = 'A'::bpchar THEN 'needapproval'::text
            WHEN uc.status = 'A1'::bpchar THEN 'approval1'::text
            WHEN uc.status = 'A2'::bpchar THEN 'approval2'::text
            WHEN uc.status = 'C'::bpchar THEN 'canceled'::text
            WHEN uc.status = 'I'::bpchar THEN 'input'::text
            WHEN uc.status = 'D'::bpchar THEN 'deletedorexpired'::text
            WHEN uc.status = 'P'::bpchar THEN 'approvedorprint'::text
            WHEN uc.status = 'F'::bpchar THEN 'return'::text
            ELSE 'unknown'::text
        END AS status_cuti,
        CASE
            WHEN uc.status = 'A'::bpchar THEN '#2196F3'::text
            WHEN uc.status = 'A1'::bpchar THEN '#536DFE'::text
            WHEN uc.status = 'A2'::bpchar THEN '#3F51B5'::text
            WHEN uc.status = 'C'::bpchar THEN '#F44336'::text
            WHEN uc.status = 'I'::bpchar THEN '#9E9E9E'::text
            WHEN uc.status = 'D'::bpchar THEN '#000000'::text
            WHEN uc.status = 'P'::bpchar THEN '#4CAF50'::text
            WHEN uc.status = 'F'::bpchar THEN '#FF5252'::text
            ELSE '#000000'::text
        END AS status_color,
        CASE
            WHEN uc.tpcuti = 'A'::bpchar THEN 'Leave'::text
            WHEN uc.tpcuti = 'B'::bpchar THEN 'Special'::text
            WHEN uc.tpcuti = 'C'::bpchar THEN 'Duty'::text
            ELSE 'unknown'::text
        END AS tipe_cuti,
        CASE
            WHEN uc.status_ptg = 'A1'::bpchar THEN 'leavecut'::text
            WHEN uc.status_ptg = 'A2'::bpchar THEN 'salarycut'::text
            ELSE NULL::text
        END AS status_potong
   FROM unique_cuti uc
     LEFT JOIN sc_mst.karyawan k ON uc.nik = k.nik::text
     LEFT JOIN sc_mst.karyawan d ON uc.pelimpahan = d.nik::text
     LEFT JOIN sc_mst.karyawan s ON uc.input_by = s.nik::text
     LEFT JOIN sc_mst.karyawan r ON uc.approval_by = r.nik
     LEFT JOIN sc_mst.ijin_khusus ik ON uc.kdijin_khusus = ik.kdijin_khusus
     LEFT JOIN sc_mst.departmen dp ON uc.kddept = dp.kddept
     LEFT JOIN sc_mst.subdepartmen sdp ON uc.kdsubdept = sdp.kdsubdept
     LEFT JOIN sc_mst.jabatan j ON uc.kdjabatan = j.kdjabatan;

     -- sc_trx.qv_uangmakan source

CREATE OR REPLACE VIEW sc_trx.qv_uangmakan
AS SELECT x2.nik,
    x2.nmlengkap,
    x2.nmdept,
    x2.nmjabatan,
    x2.tgl,
    x2.tglhari,
    x2.checktime,
    x2.keterangan,
    x2.nominal,
    x2.rank,
    x2.nominal::money AS nominalrp
   FROM ( SELECT a.nik,
            a.nmlengkap,
            a.nmdept,
            a.nmjabatan,
            a.tgl,
            a.tglhari,
            a.checktime,
            a.keterangan,
            a.nominal,
            a.rank
           FROM ( SELECT t1.nik,
                    t1.nmlengkap,
                    t1.nmdept,
                    t1.nmjabatan,
                    t1.tgl,
                    t1.tglhari,
                    t1.checktime,
                    t1.keterangan,
                    t1.nominal,
                    rank() OVER (PARTITION BY t1.nik ORDER BY t1.nik) AS rank
                   FROM ( SELECT t1_1.nik,
                            t1_1.nmlengkap,
                            t1_1.nmdept,
                            t1_1.nmjabatan,
                            t1_1.tgl,
                            t1_1.tglhari,
                            t1_1.checktime,
                            t1_1.keterangan,
                            t1_1.nominal
                           FROM ( SELECT a_1.branch,
                                    a_1.nik,
                                    a_1.tgl,
                                    a_1.checkin,
                                    a_1.checkout,
                                    a_1.nominal,
                                    a_1.keterangan,
                                    a_1.tgl_dok,
                                    a_1.dok_ref,
                                    b.nmlengkap,
                                    b.kdcabang,
                                    c.kddept,
                                    c.nmdept,
                                    e.nmjabatan,
                                    (to_char(a_1.tgl::timestamp with time zone, 'yyyy-mm-dd'::text) || ','::text) ||
CASE
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Mon'::text THEN 'Senin'::text
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Tue'::text THEN 'Selasa'::text
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Wed'::text THEN 'Rabu'::text
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Thu'::text THEN 'Kamis'::text
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Fri'::text THEN 'Jumat'::text
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Sat'::text THEN 'Sabtu'::text
 ELSE 'Out Date'::text
END AS tglhari,
                                    (
CASE
 WHEN to_char(a_1.checkin::interval, 'HH24:MI:SS'::text) IS NULL THEN ''::text
 ELSE to_char(a_1.checkin::interval, 'HH24:MI:SS'::text)
END || '|'::text) ||
CASE
 WHEN to_char(a_1.checkout::interval, 'HH24:MI:SS'::text) IS NULL THEN ''::text
 ELSE to_char(a_1.checkout::interval, 'HH24:MI:SS'::text)
END AS checktime
                                   FROM sc_trx.uangmakan a_1
                                     LEFT JOIN sc_mst.karyawan b ON a_1.nik = b.nik
                                     LEFT JOIN sc_mst.departmen c ON b.bag_dept = c.kddept
                                     LEFT JOIN sc_mst.subdepartmen d ON b.bag_dept = d.kddept AND b.subbag_dept = d.kdsubdept
                                     LEFT JOIN sc_mst.jabatan e ON b.bag_dept = e.kddept AND b.jabatan = e.kdjabatan AND b.subbag_dept = e.kdsubdept
                                  ORDER BY b.nmlengkap, a_1.tgl) t1_1
                          GROUP BY t1_1.nik, t1_1.nmlengkap, t1_1.nmdept, t1_1.nmjabatan, t1_1.tgl, t1_1.tglhari, t1_1.checktime, t1_1.keterangan, t1_1.nominal
                        UNION ALL
                         SELECT t1_1.nik,
                            t1_1.nmlengkap AS nama,
                            NULL::character varying AS nmdept,
                            NULL::character varying AS nmjabatan,
                            NULL::date AS tgl,
                            NULL::text AS tglhari,
                            NULL::text AS checktime,
                            'TOTAL'::text AS keterangan,
                            sum(t1_1.nominal) AS sum
                           FROM ( SELECT a_1.branch,
                                    a_1.nik,
                                    a_1.tgl,
                                    a_1.checkin,
                                    a_1.checkout,
                                    a_1.nominal,
                                    a_1.keterangan,
                                    a_1.tgl_dok,
                                    a_1.dok_ref,
                                    b.nmlengkap,
                                    b.kdcabang,
                                    c.kddept,
                                    c.nmdept,
                                    e.nmjabatan,
                                    (to_char(a_1.tgl::timestamp with time zone, 'yyyy-mm-dd'::text) || ','::text) ||
CASE
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Mon'::text THEN 'Senin'::text
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Tue'::text THEN 'Selasa'::text
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Wed'::text THEN 'Rabu'::text
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Thu'::text THEN 'Kamis'::text
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Fri'::text THEN 'Jumat'::text
 WHEN to_char(a_1.tgl::timestamp with time zone, 'Dy'::text) = 'Sat'::text THEN 'Sabtu'::text
 ELSE 'Out Date'::text
END AS tglhari,
                                    (
CASE
 WHEN to_char(a_1.checkin::interval, 'HH24:MI:SS'::text) IS NULL THEN ''::text
 ELSE to_char(a_1.checkin::interval, 'HH24:MI:SS'::text)
END || '|'::text) ||
CASE
 WHEN to_char(a_1.checkout::interval, 'HH24:MI:SS'::text) IS NULL THEN ''::text
 ELSE to_char(a_1.checkout::interval, 'HH24:MI:SS'::text)
END AS checktime
                                   FROM sc_trx.uangmakan a_1
                                     LEFT JOIN sc_mst.karyawan b ON a_1.nik = b.nik
                                     LEFT JOIN sc_mst.departmen c ON b.bag_dept = c.kddept
                                     LEFT JOIN sc_mst.subdepartmen d ON b.bag_dept = d.kddept AND b.subbag_dept = d.kdsubdept
                                     LEFT JOIN sc_mst.jabatan e ON b.bag_dept = e.kddept AND b.jabatan = e.kdjabatan AND b.subbag_dept = e.kdsubdept
                                  ORDER BY a_1.nik, a_1.tgl) t1_1
                          GROUP BY t1_1.nik, t1_1.nmdept, t1_1.nmjabatan, t1_1.nmlengkap) t1
                  GROUP BY t1.nik, t1.nmlengkap, t1.nmdept, t1.nmjabatan, t1.tgl, t1.tglhari, t1.checktime, t1.keterangan, t1.nominal
                  ORDER BY t1.nmlengkap, t1.tglhari) a
        UNION ALL
         SELECT x.nik,
            'GRAND TOTAL UANG MAKAN'::bpchar AS nmlengkap,
            x.nmdept,
            x.nmjabatan,
            NULL::date AS date,
            x.tglhari,
            x.checktime,
            x.keterangan,
            sum(x.nominal) AS sum,
            NULL::bigint AS rank
           FROM ( SELECT ''::text AS nik,
                    ''::text AS nmlengkap,
                    ''::text AS nmdept,
                    ''::text AS nmjabatan,
                    ''::text AS tglhari,
                    ''::text AS checktime,
                    ''::text AS keterangan,
                    sum(t1.nominal) AS nominal
                   FROM ( SELECT a.branch,
                            a.nik,
                            a.tgl,
                            a.checkin,
                            a.checkout,
                            a.nominal,
                            a.keterangan,
                            a.tgl_dok,
                            a.dok_ref,
                            b.nmlengkap,
                            b.kdcabang,
                            c.kddept,
                            c.nmdept,
                            e.nmjabatan,
                            (to_char(a.tgl::timestamp with time zone, 'yyyy-mm-dd'::text) || ','::text) ||
                                CASE
                                    WHEN to_char(a.tgl::timestamp with time zone, 'Dy'::text) = 'Mon'::text THEN 'Senin'::text
                                    WHEN to_char(a.tgl::timestamp with time zone, 'Dy'::text) = 'Tue'::text THEN 'Selasa'::text
                                    WHEN to_char(a.tgl::timestamp with time zone, 'Dy'::text) = 'Wed'::text THEN 'Rabu'::text
                                    WHEN to_char(a.tgl::timestamp with time zone, 'Dy'::text) = 'Thu'::text THEN 'Kamis'::text
                                    WHEN to_char(a.tgl::timestamp with time zone, 'Dy'::text) = 'Fri'::text THEN 'Jumat'::text
                                    WHEN to_char(a.tgl::timestamp with time zone, 'Dy'::text) = 'Sat'::text THEN 'Sabtu'::text
                                    ELSE 'Out Date'::text
                                END AS tglhari,
                            (
                                CASE
                                    WHEN to_char(a.checkin::interval, 'HH24:MI:SS'::text) IS NULL THEN ''::text
                                    ELSE to_char(a.checkin::interval, 'HH24:MI:SS'::text)
                                END || '|'::text) ||
                                CASE
                                    WHEN to_char(a.checkout::interval, 'HH24:MI:SS'::text) IS NULL THEN ''::text
                                    ELSE to_char(a.checkout::interval, 'HH24:MI:SS'::text)
                                END AS checktime
                           FROM sc_trx.uangmakan a
                             LEFT JOIN sc_mst.karyawan b ON a.nik = b.nik
                             LEFT JOIN sc_mst.departmen c ON b.bag_dept = c.kddept
                             LEFT JOIN sc_mst.subdepartmen d ON b.bag_dept = d.kddept AND b.subbag_dept = d.kdsubdept
                             LEFT JOIN sc_mst.jabatan e ON b.bag_dept = e.kddept AND b.jabatan = e.kdjabatan AND b.subbag_dept = e.kdsubdept
                          ORDER BY a.nik, a.tgl) t1
                  GROUP BY t1.nik, t1.nmdept, t1.nmjabatan, t1.nmlengkap) x
          GROUP BY x.nik, x.nmlengkap, x.nmdept, x.nmjabatan, x.tglhari, x.checktime, x.keterangan) x2;


          -- sc_tmp.v_pdca_mst source

CREATE OR REPLACE VIEW sc_tmp.v_pdca_mst
AS SELECT COALESCE(x.branch::text, ''::text) AS branch,
    COALESCE(x.nik::text, ''::text) AS nik,
    COALESCE(x.docno::text, ''::text) AS docno,
    COALESCE(x.docdate::text, ''::text) AS docdate,
    COALESCE(x.docref::text, ''::text) AS docref,
    COALESCE(x.doctype::text, ''::text) AS doctype,
    COALESCE(x.nmdoctype, ''::text) AS nmdoctype,
    COALESCE(x.docpage::text, ''::text) AS docpage,
    COALESCE(x.revision::text, ''::text) AS revision,
    COALESCE(x.tglawal::text, ''::text) AS tglawal,
    COALESCE(x.tglakhir::text, ''::text) AS tglakhir,
    COALESCE(x.global_desc, ''::text) AS global_desc,
    COALESCE(x.planperiod::text, ''::text) AS planperiod,
    COALESCE(x.ttlpercent::text, ''::text) AS ttlpercent,
    COALESCE(x.ttlplan::text, ''::text) AS ttlplan,
    COALESCE(x.avgvalue::text, ''::text) AS avgvalue,
    COALESCE(x.inputdate::text, ''::text) AS inputdate,
    COALESCE(x.inputby::text, ''::text) AS inputby,
    COALESCE(x.updatedate::text, ''::text) AS updatedate,
    COALESCE(x.updateby::text, ''::text) AS updateby,
    COALESCE(x.canceldate::text, ''::text) AS canceldate,
    COALESCE(x.cancelby::text, ''::text) AS cancelby,
    COALESCE(x.approvdate::text, ''::text) AS approvdate,
    COALESCE(x.approvby::text, ''::text) AS approvby,
    COALESCE(x.status::text, ''::text) AS status,
    COALESCE(x.nmlengkap::text, ''::text) AS nmlengkap,
    COALESCE(x.bag_dept::text, ''::text) AS bag_dept,
    COALESCE(x.nmdept::text, ''::text) AS nmdept,
    COALESCE(x.subbag_dept::text, ''::text) AS subbag_dept,
    COALESCE(x.nmsubdept::text, ''::text) AS nmsubdept,
    COALESCE(x.jabatan::text, ''::text) AS jabatan,
    COALESCE(x.nmjabatan::text, ''::text) AS nmjabatan,
    COALESCE(x.lvl_jabatan::text, ''::text) AS lvl_jabatan,
    COALESCE(x.nmlvljabatan::text, ''::text) AS nmlvljabatan,
    COALESCE(x.grade_golongan::text, ''::text) AS grade_golongan,
    COALESCE(x.nmgrade::text, ''::text) AS nmgrade,
    COALESCE(x.nik_atasan::text, ''::text) AS nik_atasan,
    COALESCE(x.nik_atasan2::text, ''::text) AS nik_atasan2,
    COALESCE(x.nmatasan1::text, ''::text) AS nmatasan1,
    COALESCE(x.nmatasan2::text, ''::text) AS nmatasan2,
    COALESCE(x.nmstatus::text, ''::text) AS nmstatus,
    COALESCE(x.docdate2, ''::text) AS docdate2,
    COALESCE(x.tglawal2, ''::text) AS tglawal2,
    COALESCE(x.tglakhir2, ''::text) AS tglakhir2
   FROM ( SELECT a.branch,
            a.nik,
            a.docno,
            a.docdate,
            a.docref,
            a.doctype,
            a.docpage,
            a.revision,
            a.tglawal,
            a.tglakhir,
            a.global_desc,
            a.planperiod,
            a.ttlpercent,
            a.ttlplan,
            a.avgvalue,
            a.inputdate,
            a.inputby,
            a.updatedate,
            a.updateby,
            a.canceldate,
            a.cancelby,
            a.approvdate,
            a.approvby,
            a.status,
            a.realisasidate,
            a.realisasiby,
            a.chec,
            b.nmlengkap,
            b.bag_dept,
            e1.nmdept,
            b.subbag_dept,
            e2.nmsubdept,
            b.jabatan,
            e3.nmjabatan,
            b.lvl_jabatan,
            e4.nmlvljabatan,
            b.grade_golongan,
            e5.nmgrade,
            b.nik_atasan,
            b.nik_atasan2,
            c.nmlengkap AS nmatasan1,
            d.nmlengkap AS nmatasan2,
                CASE
                    WHEN a.doctype = 'ISD'::bpchar THEN 'ISIDENTAL'::text
                    WHEN a.doctype = 'BRK'::bpchar THEN 'BERKALA'::text
                    ELSE NULL::text
                END AS nmdoctype,
            f.uraian AS nmstatus,
            to_char(a.docdate::timestamp with time zone, 'DD-MM-YYYY'::text) AS docdate2,
            to_char(a.tglawal::timestamp with time zone, 'DD-MM-YYYY'::text) AS tglawal2,
            to_char(a.tglakhir::timestamp with time zone, 'DD-MM-YYYY'::text) AS tglakhir2
           FROM sc_tmp.pdca_mst a
             LEFT JOIN sc_mst.karyawan b ON a.nik = b.nik
             LEFT JOIN sc_mst.karyawan c ON b.nik_atasan = c.nik
             LEFT JOIN sc_mst.karyawan d ON b.nik_atasan2 = d.nik
             LEFT JOIN sc_mst.departmen e1 ON b.bag_dept = e1.kddept
             LEFT JOIN sc_mst.subdepartmen e2 ON b.bag_dept = e2.kddept AND b.subbag_dept = e2.kdsubdept
             LEFT JOIN sc_mst.jabatan e3 ON b.bag_dept = e3.kddept AND b.subbag_dept = e3.kdsubdept AND b.jabatan = e3.kdjabatan
             LEFT JOIN sc_mst.lvljabatan e4 ON b.lvl_jabatan = e4.kdlvl
             LEFT JOIN sc_mst.jobgrade e5 ON b.grade_golongan = e5.kdgrade
             LEFT JOIN sc_mst.trxtype f ON a.status = f.kdtrx AND f.jenistrx::text = 'PDCA'::text) x
  WHERE x.nik IS NOT NULL;


  -- sc_mst.v_dtlgaji_karyawan source

CREATE OR REPLACE VIEW sc_mst.v_dtlgaji_karyawan
AS SELECT a.branch,
    a.nik,
    a.nmlengkap,
    a.callname,
    a.jk,
    a.neglahir,
    a.provlahir,
    a.kotalahir,
    a.tgllahir,
    a.kd_agama,
    a.stswn,
    a.stsfisik,
    a.ketfisik,
    a.noktp,
    a.ktp_seumurhdp,
    a.ktpdikeluarkan,
    a.tgldikeluarkan,
    a.status_pernikahan,
    a.gol_darah,
    a.negktp,
    a.provktp,
    a.kotaktp,
    a.kecktp,
    a.kelktp,
    a.alamatktp,
    a.negtinggal,
    a.provtinggal,
    a.kotatinggal,
    a.kectinggal,
    a.keltinggal,
    a.alamattinggal,
    a.nohp1,
    a.nohp2,
    a.npwp,
    a.tglnpwp,
    a.bag_dept,
    a.subbag_dept,
    a.jabatan,
    a.lvl_jabatan,
    a.grade_golongan,
    a.nik_atasan,
    a.nik_atasan2,
    a.status_ptkp,
    a.besaranptkp,
    a.tglmasukkerja,
    a.tglkeluarkerja,
    a.masakerja,
    a.statuskepegawaian,
    a.kdcabang,
    a.branchaktif,
    a.grouppenggajian,
    a.gajipokok,
    a.gajibpjs,
    a.namabank,
    a.namapemilikrekening,
    a.norek,
    a.tjshift,
    a.idabsen,
    a.email,
    a.bolehcuti,
    a.sisacuti,
    a.inputdate,
    a.inputby,
    a.updatedate,
    a.updateby,
    a.image,
    a.idmesin,
    a.cardnumber,
    a.status,
    a.tgl_ktp,
    a.costcenter,
    round(a.tj_tetap) AS tj_tetap,
    round(a.gajitetap) AS gajitetap,
    round(a.gajinaker) AS gajinaker,
    a.tjlembur,
    a.tjborong,
    a.nokk,
    a.kdwilayahnominal,
    a.kdgradejabatan,
    b.gaji,
    b.tj_prestasi,
    b.tj_jabatan,
    b.tj_masakerja,
    b1.nmdept,
    c.nmsubdept,
    d.nmlvljabatan,
    e.nmjabatan,
    f.nmlengkap AS nmatasan,
    g.nmlengkap AS nmatasan2,
    to_char(round(a.gajibpjs, 0), '999G999G999G990D'::text) AS gajibpjs1,
    to_char(round(a.gajinaker, 0), '999G999G999G990D'::text) AS gajinaker1,
    h.nmwilayahnominal,
    i.kdlvlgp,
    j.nmgradejabatan
   FROM sc_mst.karyawan a
     LEFT JOIN ( SELECT x.nik,
            to_char(round(sum(x.gaji), 0), '999G999G999G990D'::text) AS gaji,
            to_char(round(sum(x.tj_prestasi), 0), '999G999G999G990D'::text) AS tj_prestasi,
            to_char(round(sum(x.tj_jabatan), 0), '999G999G999G990D'::text) AS tj_jabatan,
            to_char(round(sum(x.tj_masakerja), 0), '999G999G999G990D'::text) AS tj_masakerja
           FROM ( SELECT dtlgaji_karyawan.nik,
                    dtlgaji_karyawan.nominal AS gaji,
                    0.00 AS tj_prestasi,
                    0.00 AS tj_jabatan,
                    0.00 AS tj_masakerja
                   FROM sc_mst.dtlgaji_karyawan
                  WHERE dtlgaji_karyawan.no_urut = 1
                UNION ALL
                 SELECT dtlgaji_karyawan.nik,
                    0.00 AS gaji,
                    dtlgaji_karyawan.nominal AS tj_prestasi,
                    0.00 AS tj_jabatan,
                    0.00 AS tj_masakerja
                   FROM sc_mst.dtlgaji_karyawan
                  WHERE dtlgaji_karyawan.no_urut = 9
                UNION ALL
                 SELECT dtlgaji_karyawan.nik,
                    0.00 AS gaji,
                    0.00 AS tj_prestasi,
                    dtlgaji_karyawan.nominal AS tj_jabatan,
                    0.00 AS tj_masakerja
                   FROM sc_mst.dtlgaji_karyawan
                  WHERE dtlgaji_karyawan.no_urut = 7
                UNION ALL
                 SELECT dtlgaji_karyawan.nik,
                    0.00 AS gaji,
                    0.00 AS tj_prestasi,
                    0.00 AS tj_jabatan,
                    dtlgaji_karyawan.nominal AS tj_masakerja
                   FROM sc_mst.dtlgaji_karyawan
                  WHERE dtlgaji_karyawan.no_urut = 8) x
          GROUP BY x.nik) b ON a.nik = b.nik
     LEFT JOIN sc_mst.departmen b1 ON a.bag_dept = b1.kddept
     LEFT JOIN sc_mst.subdepartmen c ON a.subbag_dept = c.kdsubdept AND c.kddept = a.bag_dept
     LEFT JOIN sc_mst.lvljabatan d ON a.lvl_jabatan = d.kdlvl
     LEFT JOIN sc_mst.jabatan e ON a.jabatan = e.kdjabatan AND e.kdsubdept = a.subbag_dept AND e.kddept = a.bag_dept
     LEFT JOIN sc_mst.karyawan f ON a.nik_atasan = f.nik
     LEFT JOIN sc_mst.karyawan g ON a.nik_atasan2 = g.nik
     LEFT JOIN sc_mst.m_wilayah_nominal h ON a.kdwilayahnominal = h.kdwilayahnominal
     LEFT JOIN sc_mst.m_lvlgp i ON a.kdlvlgp = i.kdlvlgp
     LEFT JOIN sc_mst.m_grade_jabatan j ON a.kdgradejabatan = j.kdgradejabatan
  WHERE COALESCE(a.statuskepegawaian, ''::bpchar) <> 'KO'::bpchar AND a.nik IS NOT NULL;


  -- sc_mst.masterkaryawan source

CREATE OR REPLACE VIEW sc_mst.masterkaryawan
AS SELECT a.nik,
    a.nmlengkap,
    a.bag_dept,
    a.subbag_dept,
    a.jabatan,
    a.lvl_jabatan,
    a.nik_atasan,
    a.nik_atasan2,
    b.nmdept,
    c.nmsubdept,
    d.nmlvljabatan,
    e.nmjabatan,
    f.nmlengkap AS nmatasan,
    g.nmlengkap AS nmatasan2
   FROM sc_mst.karyawan a
     LEFT JOIN sc_mst.departmen b ON a.bag_dept = b.kddept
     LEFT JOIN sc_mst.subdepartmen c ON a.subbag_dept = c.kdsubdept AND c.kddept = a.bag_dept
     LEFT JOIN sc_mst.lvljabatan d ON a.lvl_jabatan = d.kdlvl
     LEFT JOIN sc_mst.jabatan e ON a.jabatan = e.kdjabatan AND e.kdsubdept = a.subbag_dept AND e.kddept = a.bag_dept
     LEFT JOIN sc_mst.karyawan f ON a.nik_atasan = f.nik
     LEFT JOIN sc_mst.karyawan g ON a.nik_atasan2 = g.nik
  WHERE a.statuskepegawaian <> 'KO'::bpchar;

  -- sc_his.perawatanspk_view source

CREATE OR REPLACE VIEW sc_his.perawatanspk_view
AS SELECT COALESCE(x.nodok, ''::bpchar)::text AS nodok,
    COALESCE(x.nodokref, ''::bpchar)::text AS nodokref,
    COALESCE(x.descbarang, ''::bpchar)::text AS descbarang,
    COALESCE(x.kdgroup, ''::bpchar)::text AS kdgroup,
    COALESCE(x.kdsubgroup, ''::bpchar)::text AS kdsubgroup,
    COALESCE(x.stockcode, ''::bpchar)::text AS stockcode,
    COALESCE(x.kdbengkel, ''::bpchar)::text AS kdbengkel,
    COALESCE(x.kdsubbengkel, ''::bpchar)::text AS kdsubbengkel,
    COALESCE(x.upbengkel, ''::bpchar)::text AS upbengkel,
    COALESCE(x.jnsperawatan, ''::bpchar)::text AS jnsperawatan,
    COALESCE(x.jnsperawatanref, ''::bpchar)::text AS jnsperawatanref,
    COALESCE(to_char(x.tgldok, 'dd-mm-yyyy'::text), ''::text) AS tgldok,
    COALESCE(to_char(x.tglawal::timestamp with time zone, 'dd-mm-yyyy'::text), ''::text) AS tglawal,
    COALESCE(to_char(x.tglakhir::timestamp with time zone, 'dd-mm-yyyy'::text), ''::text) AS tglakhir,
    COALESCE(x.keterangan, ''::text) AS keterangan,
    COALESCE(x.status, ''::bpchar)::text AS status,
    COALESCE(to_char(x.inputdate, 'dd-mm-yyyy'::text), ''::text) AS inputdate,
    COALESCE(x.inputby, ''::bpchar)::text AS inputby,
    COALESCE(to_char(x.updatedate, 'dd-mm-yyyy'::text), ''::text) AS updatedate,
    COALESCE(x.updateby, ''::bpchar)::text AS updateby,
    COALESCE(x.nmbarang, ''::bpchar)::text AS nmbarang,
    COALESCE(x.kdgudang, ''::bpchar)::text AS kdgudang,
    COALESCE(x.nmbengkel, ''::character varying)::text AS nmbengkel,
    COALESCE(x.addbengkel, ''::text) AS addbengkel,
    COALESCE(x.city, ''::bpchar)::text AS city,
    COALESCE(x.phone1, ''::bpchar)::text AS phone1,
    COALESCE(x.phone2, ''::bpchar)::text AS phone2,
    COALESCE(x.nopol, ''::bpchar)::text AS nopol,
    COALESCE(x.branch_address, ''::text) AS branch_address,
    COALESCE(x.branch_phone1, ''::text) AS branch_phone1,
    COALESCE(x.branch_phone2, ''::text) AS branch_phone2,
    COALESCE(x.branch_fax, ''::text) AS branch_fax,
    COALESCE(x.nmmohon, ''::bpchar)::text AS nmmohon,
    COALESCE(x.km_awal, 0::numeric)::text AS km_awal,
    COALESCE(x.km_akhir, 0::numeric)::text AS km_akhir,
    COALESCE(x.ttlservis, 0::numeric)::text AS ttlservis,
    COALESCE(x.ttldiskon, 0::numeric)::text AS ttldiskon,
    COALESCE(x.ttldpp, 0::numeric)::text AS ttldpp,
    COALESCE(x.ttlppn, 0::numeric)::text AS ttlppn,
    COALESCE(x.ttlppnbm, 0::numeric)::text AS ttlppnbm,
    COALESCE(x.ttlnetto, 0::numeric)::text AS ttlnetto,
    COALESCE(x.typeservis, ''::bpchar)::text AS typeservis,
    COALESCE(x.nmstatus, ''::bpchar::character varying)::text AS nmstatus,
    COALESCE(x.docdate, ''::bpchar::character varying::text) AS docdate
   FROM ( SELECT a.nodok,
            a.nodokref,
            a.descbarang,
            a.kdgroup,
            a.kdsubgroup,
            a.stockcode,
            a.kdbengkel,
            a.kdsubbengkel,
            a.upbengkel,
            a.jnsperawatan,
            a.jnsperawatanref,
            a.tgldok,
            a.tglawal,
            a.tglakhir,
            a.km_awal,
            a.km_akhir,
            a.ttlservis,
            a.ttldiskon,
            a.ttldpp,
            a.ttlppn,
            a.ttlppnbm,
            a.ttlnetto,
            a.typeservis,
            a.keterangan,
            a.status,
            a.inputdate,
            a.inputby,
            a.updatedate,
            a.updateby,
            a.nodoktmp,
            b.nmbarang,
            b.kdgudang,
            c.nmbengkel,
            c.addbengkel,
            c.city,
            c.phone1,
            c.phone2,
            b.nopol,
            d.address AS branch_address,
            d.phone1 AS branch_phone1,
            d.phone2 AS branch_phone2,
            d.fax AS branch_fax,
            f.nmlengkap AS nmmohon,
            g.uraian AS nmstatus,
            to_char(a.tgldok, 'yyyy-mm-dd'::text) AS docdate
           FROM sc_his.perawatanspk a
             LEFT JOIN sc_mst.mbarang b ON a.stockcode = b.nodok AND a.kdgroup = b.kdgroup AND a.kdsubgroup = b.kdsubgroup
             LEFT JOIN sc_mst.msubbengkel c ON c.kdbengkel = a.kdbengkel AND c.kdsubbengkel = a.kdsubbengkel
             LEFT JOIN sc_mst.branch d ON 'SBYNSA'::bpchar = d.branch
             LEFT JOIN sc_his.perawatanasset e ON a.nodok = e.nodok::bpchar
             LEFT JOIN sc_mst.karyawan f ON f.nik = e.nikmohon
             LEFT JOIN sc_mst.trxtype g ON g.kdtrx = a.status AND g.jenistrx::text = 'PASSET'::text) x
  WHERE x.nodok IS NOT NULL
  ORDER BY (COALESCE(x.nodokref, ''::bpchar)::text) DESC, (COALESCE(x.nodok, ''::bpchar)::text) DESC;

--============ UM compile ============-

ALTER TABLE sc_mst.jabatan ADD um bpchar(1) NULL;

ALTER TABLE sc_mst.jabatan ADD pot_um bpchar(1) NULL;

ALTER TABLE sc_mst.jabatan ADD pot_um_ist bpchar(1) NULL;

ALTER TABLE sc_mst.jabatan ADD pot_um_pul bpchar(1) NULL;

INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('ZLBRKMPDF', 'SETUP UANG MAKAN FORMAT', 'ZLBRKMP01', NULL, NULL, 'T', 'FORMAT SETTING UNTUK FORMAT UANG MAKAN', NULL, NULL, NULL, NULL, 'ABSENSI');  


INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('ZLBRKMP01', 'SETUP UANG MAKAN FORMAT 1', 'YES', NULL, NULL, 'T', 'FORMAT 1 UM DEFAULT POTONGAN & UANG MAKAN', NULL, NULL, NULL, NULL, 'ABSENSI');
  
INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('ZLBRKMP02', 'SETUP UANG MAKAN FORMAT 2', 'YES', NULL, NULL, 'T', 'FORMAT 2 UM PERUBAHAN KOMPENSASI LEMBUR JADI UANG KEHADIRAN DAN KELEBIHAN JAM BERTINGKAT PENGKALI 30', NULL, NULL, NULL, NULL, 'ABSENSI');

INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('PTG1', 'POTONG ABSENSI', '', NULL, 7500, 'T', 'POTONGAN ABSENSI', '1015.179    ', '01.0186     ', '2017-05-03 00:49:36.000', '2018-10-16 13:01:06.000', 'IJIN');


INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('HRLBRMIN01', 'SETUP KEHADIRAN SENIN-KAMIS', 'ZLBRKMP02', '17:00:00', NULL, 'T', 'FORMAT 2 JAM MINIMUM KEHADIRAN/KELEBIHAN JAM *30 SENIN-KAMIS', NULL, NULL, NULL, NULL, 'ABSENSI             ');
INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('HRLBRMIN02', 'SETUP KEHADIRAN JUMAT', 'ZLBRKMP02', '17:00:00', NULL, 'T', 'FORMAT 2 JAM MINIMUM KEHADIRAN/KELEBIHAN JAM *30 JUMAT', NULL, NULL, NULL, NULL, 'ABSENSI             ');
INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('HRLBRMIN03', 'SETUP KEHADIRAN SABTU', 'ZLBRKMP02', '16:00:00', NULL, 'T', 'FORMAT 2 JAM MINIMUM KEHADIRAN/KELEBIHAN JAM *30 SABTU', NULL, NULL, NULL, NULL, 'ABSENSI             ');
INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('LBRPKT02', 'NOMINAL KEHADIRAN', 'ZLBRKMP02', NULL, 2500, 'T', 'SETUP NOMINAL KEHADIRAN ZLBRKMP02', NULL, NULL, NULL, NULL, 'ABSENSI             ');
INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('POTIST', 'POTONGANISTIRAHAT', '', NULL, 15000, 'T', 'POTONGANPELANGGARANISTIRAHAT', NULL, '01.0019     ', NULL, '2020-03-26 09:19:46.000', 'JAMKERJA            ');
INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('POTMAS', 'POTONGANMASUK', '', NULL, 15000, 'T', 'POTONGANPELANGGARANMASUK', NULL, '01.0019     ', NULL, '2020-03-26 09:20:10.000', 'JAMKERJA            ');
INSERT INTO sc_mst."option"
(kdoption, nmoption, value1, value2, value3, status, keterangan, input_by, update_by, input_date, update_date, group_option)
VALUES('POTPUL', 'POTONGANPULANG', NULL, NULL, 15000, 'T', 'POTONGANPELANGGARANPULANG', NULL, NULL, NULL, NULL, 'ABSENSI             ');



select * from sc_tmp.komplembur_um


  select 
  Case when a.kdcabang='SMGDMK' 
  then b.besaran-c.besaran
     else b.besaran
     end as nominal from sc_mst.karyawan a left outer join
sc_mst.uangmakan b on a.lvl_jabatan=b.kdlvl left outer join
sc_mst.kantin c on a.kdcabang=c.kdcabang



-- DDL generated by DBeaver
-- WARNING: It may differ from actual native database DDL
CREATE TABLE sc_mst.uangmakan_njrm (
	branch bpchar(6) NULL,
	kdlvl bpchar(6) NULL,
	keterangan bpchar(25) NULL,
	besaran numeric NULL,
	inputby bpchar(12) NULL,
	inputdate timestamp NULL,
	updateby bpchar(12) NULL,
	updatedate timestamp NULL
); 

INSERT INTO sc_mst.uangmakan_njrm
(branch, kdlvl, keterangan, besaran, inputby, inputdate, updateby, updatedate)
VALUES('SBYNSA', 'A', 'DIREKTUR', 15000, NULL, NULL, NULL, NULL);
INSERT INTO sc_mst.uangmakan_njrm
(branch, kdlvl, keterangan, besaran, inputby, inputdate, updateby, updatedate)
VALUES('SBYNSA', 'B', 'MANAGER', 15000, NULL, NULL, NULL, NULL);
INSERT INTO sc_mst.uangmakan_njrm
(branch, kdlvl, keterangan, besaran, inputby, inputdate, updateby, updatedate)
VALUES('SBYNSA', 'C', 'SUPERVISOR', 15000, NULL, NULL, NULL, NULL);
INSERT INTO sc_mst.uangmakan_njrm
(branch, kdlvl, keterangan, besaran, inputby, inputdate, updateby, updatedate)
VALUES('SBYNSA', 'D', 'SENIOR STAFF', 15000, NULL, NULL, NULL, NULL);
INSERT INTO sc_mst.uangmakan_njrm
(branch, kdlvl, keterangan, besaran, inputby, inputdate, updateby, updatedate)
VALUES('SBYNSA', 'E', 'STAFF', 15000, NULL, NULL, NULL, NULL);
.

-- DROP FUNCTION sc_tmp.pr_hitung_rekap_um(bpchar, date, date);

-- DROP FUNCTION sc_trx.pr_bypass_deduction(bpchar, bpchar, bpchar, bpchar);

CREATE OR REPLACE FUNCTION sc_trx.pr_bypass_deduction(vr_tglawal character, vr_tglakhir character, vr_kdcabang character, vr_userid character)
 RETURNS text
 LANGUAGE plpgsql
AS $function$
DECLARE
    /*
    UNTUK GENERATE POTONGAN UANG MAKAN SESUAI ATURAN LAMA DAN PENAMBAHAN UPDATE DATA SC_TRX.UANGMAKAN SESUAI NILAI TOTAL PENERIMAAN SETELAH PERHITUNGAN POTONGAN
    */
BEGIN
    -- Deleting records in temporary table where nodok matches vr_userid
    DELETE FROM sc_tmp.rekap_um WHERE nodok = vr_userid;
    DELETE from sc_trx.master_um where nodok IN (
        SELECT nodok FROM sc_trx.rekap_um
        WHERE kdcabang = vr_kdcabang
          AND (tglawal BETWEEN vr_tglawal::date AND vr_tglakhir::date OR tglakhir BETWEEN vr_tglawal::date AND vr_tglakhir::date)
        --AND (tglawal BETWEEN '2024-05-31'::date AND '2024-06-07'::date OR tglakhir BETWEEN '2024-05-31'::date AND '2024-06-07'::date)
    );
    delete from sc_trx.detail_um where nodok IN (
        SELECT nodok FROM sc_trx.rekap_um
        WHERE kdcabang = rekap_um.kdcabang
          AND (tglawal BETWEEN vr_tglawal::date AND vr_tglakhir::date OR tglakhir BETWEEN vr_tglawal::date AND vr_tglakhir::date)
    );
    -- Deleting records in rekap_um where kdcabang matches vr_kdcabang and dates fall within the given range
    DELETE FROM sc_trx.rekap_um
    WHERE kdcabang = vr_kdcabang
      AND (tglawal BETWEEN vr_tglawal::date AND vr_tglakhir::date OR tglakhir BETWEEN vr_tglawal::date AND vr_tglakhir::date);

    -- Calling another procedure
    PERFORM sc_trx.pr_trans_uangmakan_njrm(vr_tglawal, vr_tglakhir, vr_kdcabang, vr_userid);

    -- Deleting records in potongan_um where nik matches those in temporary table and dates fall within the given range
    DELETE FROM sc_trx.potongan_um
    WHERE nik IN (
        SELECT nik
        FROM sc_tmp.potongan_um
        WHERE sc_tmp.potongan_um.nodok = vr_userid
    )
      AND tgl BETWEEN vr_tglawal::date AND vr_tglakhir::date;

    -- Deleting records in potongan_um where kdcabang matches vr_kdcabang and dates not in the date ranges from rekap_um
    WITH date_ranges AS (
        SELECT generate_series(tglawal, tglakhir, interval '1 day')::date AS tgl
        FROM sc_trx.rekap_um
        WHERE kdcabang = vr_kdcabang
    )
    DELETE FROM sc_trx.potongan_um
    WHERE kdcabang = vr_kdcabang
      AND tgl NOT IN (
        SELECT tgl
        FROM date_ranges
    );

    -- Updating status in temporary rekap_um table
    UPDATE sc_tmp.rekap_um SET status = 'P' WHERE nodok = vr_userid;
    -- Updating sc_trx.uangmakan after get deduction
    PERFORM sc_tmp.pr_hitung_rekap_um_njrm(vr_kdcabang, vr_tglawal::date, vr_tglakhir::date);
    -- Return a success message
    RETURN 'Success';
END;
$function$
;



  -- DROP FUNCTION sc_trx.pr_trans_uangmakan(bpchar, bpchar, bpchar, bpchar);

CREATE OR REPLACE FUNCTION sc_trx.pr_trans_uangmakan_njrm(vr_tglawal character, vr_tglakhir character, vr_kdcabang character, vr_userid character)
 RETURNS text
 LANGUAGE plpgsql
AS $function$
DECLARE
/*
	AUTHOR FIKY ASHARIZA:
	CREATE DATE: 24/05/2017
	UPDATE DATE: 07/07/2017
	TITLE: PROSEDUR TARIKAN UANG MAKAN DARI TRANSREADY + KOMPONEN
	UPDATE DATE: 15/08/2019
	TITLE: PENAMBAHAN FORMAT 1 & FORMAT 2 PERUBAHAN PADA UANG KEHADIRAN
	UPDATE DATE: 17/03/2023
	TITLE: REVISI DINAS ADA CHECKIN TIDAK BOLEH DAPAT UM
	UPDATE BY: RKM
	UPDATE DATE: 21/06/2024
	TITLE: REVISI PENYAMAAN METODE DENGAN HRMS.NUSA (sc_trx.uangmakan tidak boleh dihapus)
*/
    vr_nik char(12);
    vr_nikb char(12);
    vr_branch char(12);
    vr_badgenumber char(12);
    vr_tgl_min_masuk timestamp without time zone;
    vr_tgl_max_pulang timestamp without time zone;
    vr_jam_masuk_absen time without time zone;
    vr_jam_pulang_absen time without time zone;
    vr_kdjamkerja char(12);
    vr_jam_masuk time without time zone;
    vr_jam_pulang time without time zone;
    vr_shiftke char(12);
    vr_tgl date;
    vr_um_max01 time without time zone;
    vr_um_max02 time without time zone;
    vr_um_min01 time without time zone;
    vr_um_min02 time without time zone;
    vr_lbrmin01 time without time zone;
    vr_lbrmin02 time without time zone;
    vr_lbrmin03 time without time zone;
    vr_ptg numeric;
    vr_date_now date;
    vr_dok_lembur character(25);
    vr_jabatan character(25);
    vr_komplembur numeric(18);
    vr_intv_ist numeric;
    vr_if_nol_potist numeric;
    vr_if_nol_potmas numeric;
    vr_if_nol_potpul numeric;
    vr_valkomplembur numeric;
    vr_valpotist numeric;
    vr_valpotmas numeric;
    vr_valpotpul numeric;
    vr_ZLBRKMPDF character varying(25);

    vr_jbshif char(12); vr_jblembur char(12); vr_jbum char(12); vr_jbpot_um char(12); vr_jbpot_um_ist char(12);vr_jbpot_um_pul char(12);


BEGIN

    vr_branch:=coalesce(branch,'') from sc_mst.branch where coalesce(cdefault,'')='YES';
    vr_ZLBRKMPDF:=coalesce(value1,'') from sc_mst.option where kdoption='ZLBRKMPDF'; --SETTING UANG MAKAN DISINI GAN
    --vr_ZLBRKMPDF:=select coalesce(value1,'') from sc_mst.option where kdoption='ZLBRKMPDF'; --SETTING UANG MAKAN DISINI GAN
/*
'ZLBRKMP01','SETUP UANG MAKAN FORMAT 1',
'ZLBRKMP02','SETUP UANG MAKAN FORMAT 2',
*/
    IF (vr_ZLBRKMPDF='ZLBRKMP01' or vr_ZLBRKMPDF='') THEN
        FOR vr_nik,vr_tgl IN
            select trim(nik)::text as nik,tgl from sc_trx.transready where (to_char(tgl,'YYYY-MM-DD') between vr_tglawal and vr_tglakhir)
                                                                       and nik in (select nik from sc_mst.karyawan where kdcabang=vr_kdcabang)
            order by tgl asc

            /*FOR vr_nik,vr_tgl,vr_jbshif,vr_jblembur,vr_jbum,vr_jbpot_um,vr_jbpot_um_ist,vr_jbpot_um_pul IN
                        select nik,tgl,ashift,alembur,um,pot_um,pot_um_ist,pot_um_pul from (
                        select a.nik,a.tgl,
                            coalesce(b.shift,'F') as ashift,
                            coalesce(b.lembur,'F') as alembur,
                            coalesce(b.um,'F') as um,
                            coalesce(b.pot_um,'F')as pot_um,
                            coalesce(b.pot_um_ist,'F')as pot_um_ist,
                            coalesce(b.pot_um_pul,'F')as pot_um_pul
                        from sc_trx.transready a
                        left outer join (
                                select nik ,
                                coalesce(shift,'F') as shift,
                                coalesce(lembur,'F') as lembur,
                                coalesce(um,'F') as um,
                                coalesce(pot_um,'F')as pot_um,
                                coalesce(pot_um_ist,'F')as pot_um_ist,
                                coalesce(pot_um_pul,'F')as pot_um_pul
                                from sc_mst.karyawan a join sc_mst.jabatan b on b.kdjabatan=a.jabatan and b.kddept=a.bag_dept and b.kdsubdept=a.subbag_dept
                                ) b on a.nik=b.nik
                        ) as x
                        where (to_char(tgl,'YYYY-MM-DD') between vr_tglawal and vr_tglakhir)
                        and nik in (select nik from sc_mst.karyawan where kdcabang=vr_kdcabang)
                        order by tgl asc
            */

            LOOP

                select
                    coalesce(shift,'F') as shift,
                    coalesce(lembur,'F') as lembur,
                    coalesce(um,'F') as um,
                    coalesce(pot_um,'F')as pot_um,
                    coalesce(pot_um_ist,'F')as pot_um_ist,
                    coalesce(pot_um_pul,'F')as pot_um_pul
                from sc_mst.jabatan a left outer join sc_mst.karyawan b on a.kdjabatan=b.jabatan and a.kddept=b.bag_dept and a.kdsubdept=b.subbag_dept  into vr_jbshif,vr_jblembur,vr_jbum,vr_jbpot_um,vr_jbpot_um_ist,vr_jbpot_um_pul
                    where nik=vr_nik;

                --delete from sc_trx.uangmakan where nik=vr_nik and tgl=vr_tgl;
                vr_date_now:=cast(to_char(now() ,'yyyy-mm-dd') as date);
                vr_um_max01:=value2 from sc_mst.option where kdoption='HRUMMAX01';
                vr_um_max02:=value2 from sc_mst.option where kdoption='HRUMMAX02';
                vr_um_min01:=value2 from sc_mst.option where kdoption='HRUMMIN01';
                vr_um_min02:=value2 from sc_mst.option where kdoption='HRUMMIN02';
                vr_valkomplembur:=value3 from sc_mst.option where kdoption='LBRPKT01';
                vr_valpotist:=value3 from sc_mst.option where kdoption='POTIST';
                vr_valpotmas:=value3 from sc_mst.option where kdoption='POTMAS';
                vr_valpotpul:=value3 from sc_mst.option where kdoption='POTPUL';

                vr_ptg:=value3 from sc_mst.option where kdoption='PTG1';
                vr_intv_ist:=(extract(epoch from cast(jam_istirahatselesai-jam_istirahat as time)::interval)/60)::numeric from sc_mst.jam_kerja
                             where kdjam_kerja in (select trim(kdjamkerja) from sc_trx.transready where nik=vr_nik and tgl=vr_tgl);

                /* INSERT INTO KOMPENSASI LEMBUR TEMPORARY  */
                delete from sc_tmp.komplembur_um where nik=vr_nik and nodok=vr_userid;
                if (vr_jblembur='T') then
                    select case when count(*)<=5 then 0 else vr_valkomplembur end as nominal into vr_komplembur from sc_trx.transready where jam_masuk_absen is not null and jam_pulang_absen is not null and nik=vr_nik
                                                                                                                                         and to_char(tgl,'yyyy-mm-dd') between vr_tglawal and vr_tglakhir;
                    if (vr_komplembur>0) then
                        insert into sc_tmp.komplembur_um (branch,nik,kdcabang,nodok,dokref,tglawal,tglakhir,status,flag,nominal,keterangan)
                        values	(vr_branch,vr_nik,vr_kdcabang,vr_userid,'',vr_tglawal::DATE,vr_tglakhir::DATE,'I','YES',vr_komplembur,'LEMBUR KOMPENSASI '||vr_tglawal||' s/d '||vr_tglakhir);
                    end if;
                end if;
                /* INSERT KE POTONGAN UANG MAKAN DR JAM ISTIRAHAT*/
                /* 1 POTONGAN DARI JAM ISTIRAHAT */
                delete from sc_tmp.potongan_um where nodok=vr_userid and tgl=vr_tgl and nik=vr_nik;
                if (vr_jbpot_um_ist='T') then
                     select
							case
								when ik.nodok is not null then 
									case 
									when
										((ik.tgl_jam_mulai <=jk.jam_istirahat and ik.tgl_jam_selesai > jk.jam_istirahat) or 
									(ik.tgl_jam_mulai >=jk.jam_istirahat and ik.tgl_jam_selesai > jk.jam_istirahat)) then 0
									end
                               when jam_istirahat_in is null or jam_istirahat_out is null then vr_valpotist
                               when (extract(epoch from cast(jam_istirahat_out-jam_istirahat_in as time)::interval)/60)::numeric>vr_intv_ist then vr_valpotist
                               when (extract(epoch from cast(jam_istirahat_out-jam_istirahat_in as time)::interval)/60)::numeric<15 then vr_valpotist
                               else 0 end into vr_if_nol_potist from
                        sc_trx.transready t
						left outer join sc_trx.ijin_karyawan ik on t.nik=ik.nik and t.tgl=ik.tgl_kerja and ik.kdijin_absensi='IK' and ik.type_ijin='DN' and ik.status='P'
                       left outer join sc_mst.jam_kerja jk on t.kdjamkerja=jk.kdjam_kerja
					   where t.nik=vr_nik and t.tgl=vr_tgl and jam_masuk_absen is not null and jam_pulang_absen is not null;
                    if (vr_if_nol_potist>0) then
                        insert into sc_tmp.potongan_um (branch,nik,kdcabang,nodok,dokref,doktype,tgl,status,flag,nominal,jam_istirahat_in,jam_istirahat_out,keterangan,durasi_ist)
                            (select vr_branch,nik,vr_kdcabang,vr_userid,'','POTIST',tgl,'I','YES',vr_if_nol_potist,jam_istirahat_in,jam_istirahat_out,'POTONGAN ISTIRAHAT',coalesce(floor(extract(epoch from cast(to_char(jam_istirahat_out-jam_istirahat_in,'HH24:MI:SS') as time)::interval)/60)::numeric,0) from
                                sc_trx.transready where nik=vr_nik and tgl=vr_tgl and jam_masuk_absen is not null and jam_pulang_absen is not null) ;
                    end if;
                end if;
                if (vr_jbpot_um='T') then
                    /* 2 POTONGAN DARI JAM MASUK KERJA */
                    select case when jam_masuk_absen is null or jam_masuk_absen>jam_masuk then vr_valpotmas
                                else 0 end into vr_if_nol_potmas from sc_trx.transready a
                                                                          left outer join sc_trx.listlinkjadwalcuti b on a.nik=b.nik and a.tgl=b.tgl where a.nik=vr_nik and a.tgl=vr_tgl and b.kdpokok<>'AL' and b.nodok is null;

                    if(vr_if_nol_potmas>0) then
                        insert into sc_tmp.potongan_um (branch,nik,kdcabang,nodok,dokref,doktype,tgl,status,flag,nominal,jam_istirahat_in,jam_istirahat_out,keterangan)
                            (select vr_branch,a.nik,vr_kdcabang,vr_userid,'','POTMAS',a.tgl,'I',case when ijin is not null or ijin != '' then 'NO' else 'YES' end,
                                    case when jam_masuk_absen is null or jam_masuk_absen>=jam_masuk then vr_valpotmas
                                         else 0 end,a.jam_istirahat_in,a.jam_istirahat_out,'POTONGAN TERLAMBAT' from
                                 (select * from (
                                                    select 	ta.*,case
                                                                       when ta.jam_masuk_absen=ta.jam_pulang_absen and ta.jam_masuk_absen>vr_um_max01 then null
                                                                       else ta.jam_masuk_absen end as checkin,
                                                              case
                                                                  when ta.jam_masuk_absen=ta.jam_pulang_absen and ta.jam_pulang_absen<=vr_um_max01 then null
                                                                  else ta.jam_pulang_absen end as checkout,tc.nodok as ijin,td.nodok as dinas,te.nodok as lembur
                                                    from sc_trx.transready ta
                                                             left outer join sc_trx.ijin_karyawan tc on tc.nik=ta.nik and tc.tgl_kerja=ta.tgl and tc.status='P' and tc.type_ijin='DN' AND kdijin_absensi = (select tcc.kdijin_absensi from (
                                                                                                                                                                                                                                               select
                                                                                                                                                                                                                                                   kdijin_absensi,
                                                                                                                                                                                                                                                   CASE
                                                                                                                                                                                                                                                       when kdijin_absensi IN ('DT') THEN 1
                                                                                                                                                                                                                                                       when kdijin_absensi IN ('PA') THEN 2
                                                                                                                                                                                                                                                       else 3
                                                                                                                                                                                                                                                       END as sort
                                                                                                                                                                                                                                               from sc_trx.ijin_karyawan where nik = ta.nik and tgl_kerja = ta.tgl and type_ijin = 'DN'  order by sort asc limit 1
                                                                                                                                                                                                                                           ) tcc
                                                    )
                                                             left outer join sc_trx.dinas td on td.nik=ta.nik and (ta.tgl between td.tgl_mulai and td.tgl_selesai) and td.status='P'
                                                             left outer join sc_trx.lembur te on te.nik=ta.nik and te.tgl_kerja=ta.tgl and te.status='P' ) as
                                                    x1) a
                                     left outer join sc_trx.listlinkjadwalcuti b on a.nik=b.nik and a.tgl=b.tgl where a.nik=vr_nik and a.tgl=vr_tgl and b.kdpokok<>'AL' and b.nodok is null);
                    end if;
                end if;
                if (vr_jbpot_um_pul='T') then
                    /* 3 POTONGAN TIDAK CEKLOK PULANG */
                    select case when jam_pulang_absen is null or jam_pulang_absen<jam_pulang then vr_valpotpul
                                else 0 end into vr_if_nol_potpul from sc_trx.transready a
                                                                          left outer join sc_trx.listlinkjadwalcuti b on a.nik=b.nik and a.tgl=b.tgl where a.nik=vr_nik and a.tgl=vr_tgl and b.kdpokok<>'AL' and b.nodok is null;

                    if(vr_if_nol_potpul>0) then
                        insert into sc_tmp.potongan_um (branch,nik,kdcabang,nodok,dokref,doktype,tgl,status,flag,nominal,jam_istirahat_in,jam_istirahat_out,keterangan)
                            (select vr_branch,a.nik,vr_kdcabang,vr_userid,'','POTPUL',a.tgl,'I',case when ijin is not null or ijin != '' then 'NO' else 'YES' end,case when jam_pulang_absen is null or jam_pulang_absen<jam_pulang then vr_valpotpul
                                                                                                                                                                       else 0 end,a.jam_istirahat_in,a.jam_istirahat_out,'POTONGAN TIDAK CEKLOK PULANG' from
                                 (select * from (
                                                    select 	ta.*,case
                                                                       when ta.jam_masuk_absen=ta.jam_pulang_absen and ta.jam_masuk_absen>vr_um_max01 then null
                                                                       else ta.jam_masuk_absen end as checkin,
                                                              case
                                                                  when ta.jam_masuk_absen=ta.jam_pulang_absen and ta.jam_pulang_absen<=vr_um_max01 then null
                                                                  else ta.jam_pulang_absen end as checkout,tc.nodok as ijin,td.nodok as dinas,te.nodok as lembur
                                                    from sc_trx.transready ta
                                                             left outer join sc_trx.ijin_karyawan tc on tc.nik=ta.nik and tc.tgl_kerja=ta.tgl and tc.status='P' and tc.nodok = (
                                                        select nodok from(
                                                                             select
                                                                                 nodok,
                                                                                 case
                                                                                     when type_ijin = 'DN' THEN 0
                                                                                     else 1
                                                                                     END AS type_sort,
                                                                                 CASE
                                                                                     WHEN kdijin_absensi IN ('DT','PA') THEN 0
                                                                                     ELSE 1
                                                                                     END as kdijin_sort
                                                                             from sc_trx.ijin_karyawan where nik = tc.nik AND tgl_kerja = tc.tgl_kerja
                                                                             order by type_sort ASC, kdijin_sort ASC limit 1
                                                                         ) aa
                                                    )
                                                             left outer join sc_trx.dinas td on td.nik=ta.nik and (ta.tgl between td.tgl_mulai and td.tgl_selesai) and td.status='P'
                                                             left outer join sc_trx.lembur te on te.nik=ta.nik and te.tgl_kerja=ta.tgl and te.status='P' ) as
                                                    x1)a
                                     left outer join sc_trx.listlinkjadwalcuti b on a.nik=b.nik and a.tgl=b.tgl where a.nik=vr_nik and a.tgl=vr_tgl and b.kdpokok<>'AL' and b.nodok is null);
                    end if;
                end if;
                /* UANG SEWA KENDARAAN YG SUDAH FINAL */
                if not exists(select * from sc_tmp.master_um where nik=vr_nik and nodok=vr_userid and branch=vr_branch and tgl=vr_tgl) then
                    insert into sc_tmp.master_um (branch,nik,kdcabang,nodok,dokref,tgl,status,total,uangmkn,potongan,sewa,lembur_um,keterangan)
                    values
                        (vr_branch,vr_nik,vr_kdcabang,vr_userid,'',vr_tgl,'I',0,0,0,0,0,'');
                end if;
                update sc_tmp.master_um set sewa=(select sum(total_besaran) from sc_trx.mtrmst a left outer join sc_trx.transready b on a.nik=b.nik and to_char(a.tanggal_akhir,'yyyy-mm-dd')::date=b.tgl
                    and a.status='P' where a.nik=vr_nik and b.tgl=vr_tgl )
                where nik=vr_nik and nodok=vr_userid and branch=vr_branch and tgl=vr_tgl;

                update sc_tmp.master_um set total=(select  coalesce(sum(coalesce(sewa,0.0)+coalesce(lembur_um,0.0)+(
                    case when coalesce(uangmkn,0.0)-coalesce(potongan,0.0)<0 then 0
                         else coalesce(coalesce(uangmkn,0.0)-coalesce(potongan,0.0),0.0) end)),0.0) from sc_tmp.master_um where nik=vr_nik and nodok=vr_userid and branch=vr_branch and tgl=vr_tgl)
                where nik=vr_nik and nodok=vr_userid and branch=vr_branch and tgl=vr_tgl;


                /* UANG MAKAN DTL KARYAWAN */
                delete from sc_tmp.uangmakan where nodok=vr_userid and tgl=vr_tgl and nik=vr_nik;
                if (vr_jbum='T') then
                    insert into sc_tmp.uangmakan
                    (branch,nodok,nik,kdcabang,dokref,tgl,checkin,checkout,nominal,keterangan,status)
                        (select vr_branch,vr_userid,ta.nik,vr_kdcabang,case when tc.nodok is not null then tc.nodok else td.nodok end as nodok ,ta.tgl,ta.checkin,ta.checkout,
                                case 	when  checkin is null and checkout is null then 0
                                        when  checkin is not null and checkout is not null and td.nodok is not null then 0
                                        when  checkin is null and checkout is null and td.nodok is not null then 0
                                    /*when  checkin<=vr_um_min01 and checkout>jam_pulang and te.nodok is null then besaran
                                    ---when  checkin<=vr_um_min01 and checkout>jam_pulang and te.nodok is not null then besaran+besaran
                                    when  checkin>vr_um_min01 and vr_um_max01<checkout and kdijin_absensi is null then besaran
                                    when  checkin>vr_um_min01  and checkout>jam_pulang and kdijin_absensi is null then 0
                                    when  checkin is null and checkout>jam_pulang and kdijin_absensi is null  then 0
                                    when  checkin<vr_um_min01 and checkout is null  and kdijin_absensi is null  then 0
                                    when  checkin<vr_um_min01 and checkout<vr_um_max01 then 0
                                    when  checkin<vr_um_min01 and checkout>=vr_um_max01 and to_char(tgl,'Dy')<>'Sat' then besaran
                                    when  checkin<vr_um_min01 and checkout>=vr_um_max02 and to_char(tgl,'Dy')='Sat' then besaran
                                    when  checkin<vr_um_min01 and checkout is null and kdijin_absensi='IK' and cast(to_char(tc.approval_date,'yyyy-mm-dd')as date)<=vr_date_now  then besaran
                                    when  cast(to_char(tc.approval_date,'yyyy-mm-dd')as date)=ta.tgl  then besaran */

                                        else besaran
                                    end as nominal,
                                case 	when checkin is null and checkout is null and td.nodok is null then 'TIDAK MASUK KANTOR'
                                        when checkin is null and checkout is null and td.nodok is not null then 'DINAS DENGAN NO DINAS :'||td.nodok||'|| APP TGL: '||to_char(td.approval_date,'yyyy-mm-dd')
                                        when checkin is not null and checkout is not null and td.nodok is not null then 'DINAS DENGAN NO DINAS :'||td.nodok||'|| APP TGL: '||to_char(td.approval_date,'yyyy-mm-dd')
                                        when checkin<jam_masuk and checkout>jam_pulang and te.nodok is null then 'TEPAT WAKTU'
                                        when checkin<jam_masuk and checkout>jam_pulang and te.nodok is not null then 'TEPAT WAKTU + Lembur :'||te.nodok
                                        when checkin>jam_masuk and checkout<jam_pulang AND tc.nodok is not null then 'IJIN DGN NO :'||tc.nodok||'|| APP TGL: '||to_char(tc.approval_date,'yyyy-mm-dd')
                                        when checkin>jam_masuk and checkout<jam_pulang then 'TELAT MASUK/PULANG AWAL'
                                        when checkin>=jam_masuk and checkout>jam_pulang and tc.kdijin_absensi is null then 'TELAT MASUK'
                                        when checkin>=jam_masuk and checkout>jam_pulang and tc.kdijin_absensi is not null then 'IJIN DGN NO :'||tc.nodok||'|| APP TGL: '||to_char(tc.approval_date,'yyyy-mm-dd')
                                        when checkin isnull and checkout>jam_pulang then 'TIDAK CEKLOG MASUK'
                                        when checkin<jam_masuk and checkout is null and tc.kdijin_absensi is null then 'TIDAK CEKLOG PULANG'
                                        when checkin<jam_masuk and checkout<jam_pulang then 'PULANG AWAL'
                                        when checkin<vr_um_min01  and checkout is null and kdijin_absensi='IK' then 'IJIN DGN NO :'||tc.nodok||'|| APP TGL: '||to_char(tc.approval_date,'yyyy-mm-dd')
                                    end as keterangan,'I' as status from (
                                                                             select vr_branch as branch,a.nik,b.nmlengkap,c.kddept,c.nmdept,e.kdjabatan,e.nmjabatan,a.tgl,
                                                                                    case
                                                                                        when a.jam_masuk_absen=a.jam_pulang_absen and a.jam_masuk_absen>vr_um_max01 then null
                                                                                        else a.jam_masuk_absen end as checkin,
                                                                                    case
                                                                                        when a.jam_masuk_absen=a.jam_pulang_absen and a.jam_pulang_absen<=vr_um_max01 then null
                                                                                        else a.jam_pulang_absen end as checkout,null as nominal,'' as keterangan,b.kdcabang,b.lvl_jabatan,a.jam_masuk,a.jam_pulang,f.besaran as kantin from sc_trx.transready a
                                                                                                                                                                                                                                                left outer join sc_mst.karyawan b on a.nik=b.nik
                                                                                                                                                                                                                                                left outer join sc_mst.departmen c on b.bag_dept=c.kddept
                                                                                                                                                                                                                                                left outer join sc_mst.subdepartmen d on b.subbag_dept=d.kdsubdept and b.bag_dept=d.kddept
                                                                                                                                                                                                                                                left outer join sc_mst.jabatan e on b.jabatan=e.kdjabatan and b.subbag_dept=e.kdsubdept and b.bag_dept=e.kddept
                                                                                                                                                                                                                                                left outer join sc_mst.kantin f on b.kdcabang=f.kdcabang
                                                                         ) as ta
                                                                             left outer join sc_mst.uangmakan tb on tb.kdlvl=ta.lvl_jabatan
                                                                             left outer join sc_trx.ijin_karyawan tc on tc.nik=ta.nik and tc.tgl_kerja=ta.tgl and tc.status='P' and tc.type_ijin='DN' AND kdijin_absensi = (select tcc.kdijin_absensi from (
                                                                                                                                                                                                                                                               select
                                                                                                                                                                                                                                                                   kdijin_absensi,
                                                                                                                                                                                                                                                                   CASE
                                                                                                                                                                                                                                                                       when kdijin_absensi IN ('DT') THEN 1
                                                                                                                                                                                                                                                                       when kdijin_absensi IN ('PA') THEN 2
                                                                                                                                                                                                                                                                       else 3
                                                                                                                                                                                                                                                                       END as sort
                                                                                                                                                                                                                                                               from sc_trx.ijin_karyawan where nik = ta.nik and tgl_kerja = ta.tgl and type_ijin = 'DN'  order by sort asc limit 1
                                                                                                                                                                                                                                                           ) tcc
                        )  --and to_char(tc.approval_date,'yyyy-mm-dd')<=to_char(now(),'yyyy-mm-dd')
                                                                             left outer join sc_trx.dinas td on td.nik=ta.nik and (ta.tgl between td.tgl_mulai and td.tgl_selesai) and td.status='P'
                                                                             left outer join sc_trx.lembur te on te.nik=ta.nik and te.tgl_kerja=ta.tgl and to_char(ta.checkout,'HH23:MI:SS')>='18:00:00' and te.status='P'/*LEMBUR */
                         where ta.lvl_jabatan<>'A' and ta.nik=vr_nik and ta.tgl=vr_tgl
                         group by ta.nik,ta.nmlengkap,ta.tgl,ta.checkin,ta.checkout,ta.kdcabang,ta.jam_masuk,ta.jam_pulang,tb.besaran,ta.lvl_jabatan,ta.kantin,tc.kdijin_absensi,tc.tgl_kerja,td.nodok,td.approval_date,tc.nodok,tc.approval_date,te.nodok
                         ORDER BY NMLENGKAP);
                end if;
            END LOOP;


--SETUP FORMAT 2
    ELSEIF (vr_ZLBRKMPDF='ZLBRKMP02') THEN

        delete from sc_tmp.komplembur_um where nodok=vr_userid;
        delete from sc_tmp.potongan_um where nodok=vr_userid ;
        delete from sc_tmp.uangmakan where nodok=vr_userid ;
        FOR vr_nik,vr_tgl IN
            select trim(nik)::text as nik,tgl from sc_trx.transready where (to_char(tgl,'YYYY-MM-DD') between vr_tglawal and vr_tglakhir)
                                                                       and nik in (select nik from sc_mst.karyawan where kdcabang=vr_kdcabang)
            order by tgl asc

            /*
             FOR vr_nik,vr_tgl,vr_jbshif,vr_jblembur,vr_jbum,vr_jbpot_um,vr_jbpot_um_ist,vr_jbpot_um_pul IN
                        select nik,tgl,ashift,alembur,um,pot_um,pot_um_ist,pot_um_pul from (
                        select a.nik,a.tgl,
                            coalesce(b.shift,'F') as ashift,
                            coalesce(b.lembur,'F') as alembur,
                            coalesce(b.um,'F') as um,
                            coalesce(b.pot_um,'F')as pot_um,
                            coalesce(b.pot_um_ist,'F')as pot_um_ist,
                            coalesce(b.pot_um_pul,'F')as pot_um_pul
                        from sc_trx.transready a
                        left outer join (
                                select nik ,
                                coalesce(shift,'F') as shift,
                                coalesce(lembur,'F') as lembur,
                                coalesce(um,'F') as um,
                                coalesce(pot_um,'F')as pot_um,
                                coalesce(pot_um_ist,'F')as pot_um_ist,
                                coalesce(pot_um_pul,'F')as pot_um_pul
                                from sc_mst.karyawan a join sc_mst.jabatan b on b.kdjabatan=a.jabatan and b.kddept=a.bag_dept and b.kdsubdept=a.subbag_dept
                                ) b on a.nik=b.nik
                        ) as x
                        where (to_char(tgl,'YYYY-MM-DD') between vr_tglawal and vr_tglakhir)
                        and nik in (select nik from sc_mst.karyawan where kdcabang=vr_kdcabang)
                        order by tgl asc
            */

            LOOP


                select
                    coalesce(shift,'F') as shift,
                    coalesce(lembur,'F') as lembur,
                    coalesce(um,'F') as um,
                    coalesce(pot_um,'F')as pot_um,
                    coalesce(pot_um_ist,'F')as pot_um_ist,
                    coalesce(pot_um_pul,'F')as pot_um_pul
                from sc_mst.jabatan a left outer join sc_mst.karyawan b on a.kdjabatan=b.jabatan and a.kddept=b.bag_dept and a.kdsubdept=b.subbag_dept  into vr_jbshif,vr_jblembur,vr_jbum,vr_jbpot_um,vr_jbpot_um_ist,vr_jbpot_um_pul
                    where nik=vr_nik;

                vr_date_now:=cast(to_char(now() ,'yyyy-mm-dd') as date);
                vr_um_max01:=value2 from sc_mst.option where kdoption='HRUMMAX01';
                vr_um_max02:=value2 from sc_mst.option where kdoption='HRUMMAX02';
                vr_um_min01:=value2 from sc_mst.option where kdoption='HRUMMIN01';
                vr_um_min02:=value2 from sc_mst.option where kdoption='HRUMMIN02';
                vr_valkomplembur:=value3 from sc_mst.option where kdoption='LBRPKT02';
                vr_valpotist:=value3 from sc_mst.option where kdoption='POTIST';
                vr_valpotmas:=value3 from sc_mst.option where kdoption='POTMAS';
                vr_valpotpul:=value3 from sc_mst.option where kdoption='POTPUL';
                /* JAM MINIMAL LEMBUR */
                vr_lbrmin01:=value2 from sc_mst.option where kdoption='HRLBRMIN01'; --SENIN-KAMIS
                vr_lbrmin02:=value2 from sc_mst.option where kdoption='HRLBRMIN02'; --JUMAT
                vr_lbrmin03:=value2 from sc_mst.option where kdoption='HRLBRMIN03'; --SABTU

                vr_ptg:=value3 from sc_mst.option where kdoption='PTG1';
                vr_intv_ist:=(extract(epoch from cast(jam_istirahatselesai-jam_istirahat as time)::interval)/60)::numeric from sc_mst.jam_kerja
                             where kdjam_kerja in (select trim(kdjamkerja) from sc_trx.transready where nik=vr_nik and tgl=vr_tgl);

                /* INSERT INTO KOMPENSASI LEMBUR TEMPORARY  */

                if (vr_jblembur='T') then
                    select case
                               when to_char(tgl, 'Dy') in ('Mon','Tue','Wed','Thu')  and jam_pulang_absen>=vr_lbrmin01 then floor(extract(epoch from cast(jam_pulang_absen-vr_lbrmin01 as time)::interval)/60::numeric/30) * vr_valkomplembur
                               when to_char(tgl, 'Dy') in ('Fri') and jam_pulang_absen>=vr_lbrmin02 then floor(extract(epoch from cast(jam_pulang_absen-vr_lbrmin02 as time)::interval)/60::numeric/30) * vr_valkomplembur
                               when to_char(tgl, 'Dy') in ('Sat') and jam_pulang_absen>=vr_lbrmin03 then floor(extract(epoch from cast(jam_pulang_absen-vr_lbrmin03 as time)::interval)/60::numeric/30) * vr_valkomplembur
                               else 0 end as nominalx,jam_masuk_absen,jam_pulang_absen into vr_komplembur,vr_jam_masuk_absen,vr_jam_pulang_absen
                    from sc_trx.transready where nik=vr_nik and tgl=vr_tgl and jam_masuk_absen is not null and jam_pulang_absen is not null;

/*				select * from sc_trx.transready limit 20
				select case
					when kdjamkerja='NSA' and jam_pulang_absen>= (select value2 from sc_mst.option where kdoption='HRLBRMIN01') then floor(extract(epoch from cast(jam_pulang_absen-(select value2 from sc_mst.option where kdoption='HRLBRMIN01') as time)::interval)/60::numeric/30) * (select value3 from sc_mst.option where kdoption='LBRPKT02')
					when kdjamkerja='NSB' and jam_pulang_absen>= (select value2 from sc_mst.option where kdoption='HRLBRMIN02') then floor(extract(epoch from cast(jam_pulang_absen-(select value2 from sc_mst.option where kdoption='HRLBRMIN02') as time)::interval)/60::numeric/30) * (select value3 from sc_mst.option where kdoption='LBRPKT02')
					when kdjamkerja='NSC' and jam_pulang_absen>= (select value2 from sc_mst.option where kdoption='HRLBRMIN03') then floor(extract(epoch from cast(jam_pulang_absen-(select value2 from sc_mst.option where kdoption='HRLBRMIN03') as time)::interval)/60::numeric/30) * (select value3 from sc_mst.option where kdoption='LBRPKT02')
				else 0 end as nominal_kompensasi  ,
				case
					when kdjamkerja='NSA' and jam_pulang_absen>= (select value2 from sc_mst.option where kdoption='HRLBRMIN01')then floor(extract(epoch from cast(jam_pulang_absen-(select value2 from sc_mst.option where kdoption='HRLBRMIN01') as time)::interval)/60::numeric/30)
					when kdjamkerja='NSB' and jam_pulang_absen>= (select value2 from sc_mst.option where kdoption='HRLBRMIN02')then floor(extract(epoch from cast(jam_pulang_absen-(select value2 from sc_mst.option where kdoption='HRLBRMIN02') as time)::interval)/60::numeric/30)
					when kdjamkerja='NSC' and jam_pulang_absen>= (select value2 from sc_mst.option where kdoption='HRLBRMIN03')then floor(extract(epoch from cast(jam_pulang_absen-(select value2 from sc_mst.option where kdoption='HRLBRMIN03') as time)::interval)/60::numeric/30)
				else 0 end as x_kompensasi ,jam_pulang_absen
				from sc_trx.transready where nik='01.0040' and tgl='2019-04-27' and jam_masuk_absen is not null and jam_pulang_absen is not null;
*/
                    if (vr_komplembur>0) then
                        insert into sc_tmp.komplembur_um (branch,nik,kdcabang,nodok,dokref,tglawal,tglakhir,status,flag,nominal,keterangan,jamawal,jamakhir)
                            (select vr_branch,vr_nik,vr_kdcabang,vr_userid,'',vr_tgl::DATE,vr_tgl::DATE,'I','YES',vr_komplembur,'UANG KEHADIRAN',vr_jam_masuk_absen,vr_jam_pulang_absen
                             from sc_trx.transready where nik=vr_nik and tgl=vr_tgl );
                    end if;
                    --RAISE NOTICE 'Calling cs_create_job(%)', vr_nik||'-'||vr_tgl;
                end if;
                /* INSERT KE POTONGAN UANG MAKAN DR JAM ISTIRAHAT*/
                /* 1 POTONGAN DARI JAM ISTIRAHAT */
                delete from sc_tmp.potongan_um where nodok=vr_userid and tgl=vr_tgl and nik=vr_nik;
                if (vr_jbpot_um_ist='T') then
                    select
							case
								when ik.nodok is not null then 
									case 
									when
										((ik.tgl_jam_mulai <=jk.jam_istirahat and ik.tgl_jam_selesai > jk.jam_istirahat) or 
									(ik.tgl_jam_mulai >=jk.jam_istirahat and ik.tgl_jam_selesai > jk.jam_istirahat)) then 0
									end
                               when jam_istirahat_in is null or jam_istirahat_out is null then vr_valpotist
                               when (extract(epoch from cast(jam_istirahat_out-jam_istirahat_in as time)::interval)/60)::numeric>vr_intv_ist then vr_valpotist
                               when (extract(epoch from cast(jam_istirahat_out-jam_istirahat_in as time)::interval)/60)::numeric<15 then vr_valpotist
                               else 0 end into vr_if_nol_potist from
                        sc_trx.transready t
						left outer join sc_trx.ijin_karyawan ik on t.nik=ik.nik and t.tgl=ik.tgl_kerja and ik.kdijin_absensi='IK' and ik.type_ijin='DN' and ik.status='P'
                       left outer join sc_mst.jam_kerja jk on t.kdjamkerja=jk.kdjam_kerja
					   where t.nik=vr_nik and t.tgl=vr_tgl and jam_masuk_absen is not null and jam_pulang_absen is not null;
                    if (vr_if_nol_potist>0) then
                        insert into sc_tmp.potongan_um (branch,nik,kdcabang,nodok,dokref,doktype,tgl,status,flag,nominal,jam_istirahat_in,jam_istirahat_out,keterangan,durasi_ist)
                            (select vr_branch,nik,vr_kdcabang,vr_userid,'','POTIST',tgl,'I','YES',vr_if_nol_potist,jam_istirahat_in,jam_istirahat_out,'POTONGAN ISTIRAHAT',coalesce(floor(extract(epoch from cast(to_char(jam_istirahat_out-jam_istirahat_in,'HH24:MI:SS') as time)::interval)/60)::numeric,0) from
                                sc_trx.transready where nik=vr_nik and tgl=vr_tgl and jam_masuk_absen is not null and jam_pulang_absen is not null) ;
                    end if;
                end if;
                if (vr_jbpot_um='T') then
                    /* 2 POTONGAN DARI JAM MASUK KERJA */
                    select case when jam_masuk_absen is null or jam_masuk_absen>jam_masuk then vr_valpotmas
                                else 0 end into vr_if_nol_potmas from sc_trx.transready a
                                                                          left outer join sc_trx.listlinkjadwalcuti b on a.nik=b.nik and a.tgl=b.tgl where a.nik=vr_nik and a.tgl=vr_tgl and b.kdpokok<>'AL' and b.nodok is null;

                    if(vr_if_nol_potmas>0) then
                        insert into sc_tmp.potongan_um (branch,nik,kdcabang,nodok,dokref,doktype,tgl,status,flag,nominal,jam_istirahat_in,jam_istirahat_out,keterangan)
                            (select vr_branch,a.nik,vr_kdcabang,vr_userid,'','POTMAS',a.tgl,'I',case when ijin is not null or ijin != '' then 'NO' else 'YES' end,
                                    case when jam_masuk_absen is null or jam_masuk_absen>=jam_masuk then vr_valpotmas
                                         else 0 end,a.jam_istirahat_in,a.jam_istirahat_out,'POTONGAN TERLAMBAT' from
                                 (select * from (
                                                    select 	ta.*,case
                                                                       when ta.jam_masuk_absen=ta.jam_pulang_absen and ta.jam_masuk_absen>vr_um_max01 then null
                                                                       else ta.jam_masuk_absen end as checkin,
                                                              case
                                                                  when ta.jam_masuk_absen=ta.jam_pulang_absen and ta.jam_pulang_absen<=vr_um_max01 then null
                                                                  else ta.jam_pulang_absen end as checkout,tc.nodok as ijin,td.nodok as dinas,te.nodok as lembur
                                                    from sc_trx.transready ta
                                                             left outer join sc_trx.ijin_karyawan tc on tc.nik=ta.nik and tc.tgl_kerja=ta.tgl and tc.status='P' and tc.type_ijin='DN' AND kdijin_absensi = (select tcc.kdijin_absensi from (
                                                                                                                                                                                                                                               select
                                                                                                                                                                                                                                                   kdijin_absensi,
                                                                                                                                                                                                                                                   CASE
                                                                                                                                                                                                                                                       when kdijin_absensi IN ('DT') THEN 1
                                                                                                                                                                                                                                                       when kdijin_absensi IN ('PA') THEN 2
                                                                                                                                                                                                                                                       else 3
                                                                                                                                                                                                                                                       END as sort
                                                                                                                                                                                                                                               from sc_trx.ijin_karyawan where nik = ta.nik and tgl_kerja = ta.tgl and type_ijin = 'DN'  order by sort asc limit 1
                                                                                                                                                                                                                                           ) tcc
                                                    )
                                                             left outer join sc_trx.dinas td on td.nik=ta.nik and (ta.tgl between td.tgl_mulai and td.tgl_selesai) and td.status='P'
                                                             left outer join sc_trx.lembur te on te.nik=ta.nik and te.tgl_kerja=ta.tgl and te.status='P' ) as
                                                    x1) a
                                     left outer join sc_trx.listlinkjadwalcuti b on a.nik=b.nik and a.tgl=b.tgl where a.nik=vr_nik and a.tgl=vr_tgl and b.kdpokok<>'AL' and b.nodok is null);
                    end if;
                end if;
                if (vr_jbpot_um_pul='T') then
                    /* 3 POTONGAN TIDAK CEKLOK PULANG */
                    select case when jam_pulang_absen is null or jam_pulang_absen<jam_pulang then vr_valpotpul
                                else 0 end into vr_if_nol_potpul from sc_trx.transready a
                                                                          left outer join sc_trx.listlinkjadwalcuti b on a.nik=b.nik and a.tgl=b.tgl where a.nik=vr_nik and a.tgl=vr_tgl and b.kdpokok<>'AL' and b.nodok is null;

                    if(vr_if_nol_potpul>0) then
                        insert into sc_tmp.potongan_um (branch,nik,kdcabang,nodok,dokref,doktype,tgl,status,flag,nominal,jam_istirahat_in,jam_istirahat_out,keterangan)
                            (select vr_branch,a.nik,vr_kdcabang,vr_userid,'','POTPUL',a.tgl,'I',case when ijin is not null or ijin != '' then 'NO' else 'YES' end,case when jam_pulang_absen is null or jam_pulang_absen<jam_pulang then vr_valpotpul
                                                                                                                                                                       else 0 end,a.jam_istirahat_in,a.jam_istirahat_out,'POTONGAN TIDAK CEKLOK PULANG' from
                                 (select * from (
                                                    select 	ta.*,case
                                                                       when ta.jam_masuk_absen=ta.jam_pulang_absen and ta.jam_masuk_absen>vr_um_max01 then null
                                                                       else ta.jam_masuk_absen end as checkin,
                                                              case
                                                                  when ta.jam_masuk_absen=ta.jam_pulang_absen and ta.jam_pulang_absen<=vr_um_max01 then null
                                                                  else ta.jam_pulang_absen end as checkout,tc.nodok as ijin,td.nodok as dinas,te.nodok as lembur
                                                    from sc_trx.transready ta
                                                             left outer join sc_trx.ijin_karyawan tc on tc.nik=ta.nik and tc.tgl_kerja=ta.tgl and tc.status='P' and tc.type_ijin='DN' AND kdijin_absensi = (select tcc.kdijin_absensi from (
                                                                                                                                                                                                                                               select
                                                                                                                                                                                                                                                   kdijin_absensi,
                                                                                                                                                                                                                                                   CASE
                                                                                                                                                                                                                                                       when kdijin_absensi IN ('DT') THEN 1
                                                                                                                                                                                                                                                       when kdijin_absensi IN ('PA') THEN 2
                                                                                                                                                                                                                                                       else 3
                                                                                                                                                                                                                                                       END as sort
                                                                                                                                                                                                                                               from sc_trx.ijin_karyawan where nik = ta.nik and tgl_kerja = ta.tgl and type_ijin = 'DN'  order by sort asc limit 1
                                                                                                                                                                                                                                           ) tcc
                                                    )
                                                             left outer join sc_trx.dinas td on td.nik=ta.nik and (ta.tgl between td.tgl_mulai and td.tgl_selesai) and td.status='P'
                                                             left outer join sc_trx.lembur te on te.nik=ta.nik and te.tgl_kerja=ta.tgl and te.status='P' ) as
                                                    x1)a
                                     left outer join sc_trx.listlinkjadwalcuti b on a.nik=b.nik and a.tgl=b.tgl where a.nik=vr_nik and a.tgl=vr_tgl and b.kdpokok<>'AL' and b.nodok is null);
                    end if;
                end if;
                /* UANG SEWA KENDARAAN YG SUDAH FINAL */
                if not exists(select * from sc_tmp.master_um where nik=vr_nik and nodok=vr_userid and branch=vr_branch and tgl=vr_tgl) then
                    insert into sc_tmp.master_um (branch,nik,kdcabang,nodok,dokref,tgl,status,total,uangmkn,potongan,sewa,lembur_um,keterangan)
                    values
                        (vr_branch,vr_nik,vr_kdcabang,vr_userid,'',vr_tgl,'I',0,0,0,0,0,'');
                end if;
                update sc_tmp.master_um set sewa=(select sum(total_besaran) from sc_trx.mtrmst a left outer join sc_trx.transready b on a.nik=b.nik and to_char(a.tanggal_akhir,'yyyy-mm-dd')::date=b.tgl
                    and a.status='P' where a.nik=vr_nik and b.tgl=vr_tgl )
                where nik=vr_nik and nodok=vr_userid and branch=vr_branch and tgl=vr_tgl;

                update sc_tmp.master_um set total=(select  coalesce(sum(coalesce(sewa,0.0)+coalesce(lembur_um,0.0)+(
                    case when coalesce(uangmkn,0.0)-coalesce(potongan,0.0)<0 then 0
                         else coalesce(coalesce(uangmkn,0.0)-coalesce(potongan,0.0),0.0) end)),0.0) from sc_tmp.master_um where nik=vr_nik and nodok=vr_userid and branch=vr_branch and tgl=vr_tgl)
                where nik=vr_nik and nodok=vr_userid and branch=vr_branch and tgl=vr_tgl;


                /* UANG MAKAN DTL KARYAWAN */

                if (vr_jbum='T') then
                    insert into sc_tmp.uangmakan
                    (branch,nodok,nik,kdcabang,dokref,tgl,checkin,checkout,nominal,keterangan,status)
                        (select vr_branch,vr_userid,ta.nik,vr_kdcabang,case when tc.nodok is not null then tc.nodok else td.nodok end as nodok ,ta.tgl,ta.checkin,ta.checkout,
                                case 	when  checkin is null and checkout is null then 0
                                    /*when  checkin<=vr_um_min01 and checkout>jam_pulang and te.nodok is null then besaran
                                    ---when  checkin<=vr_um_min01 and checkout>jam_pulang and te.nodok is not null then besaran+besaran
                                    when  checkin>vr_um_min01 and vr_um_max01<checkout and kdijin_absensi is null then besaran
                                    when  checkin>vr_um_min01  and checkout>jam_pulang and kdijin_absensi is null then 0
                                    when  checkin is null and checkout>jam_pulang and kdijin_absensi is null  then 0
                                    when  checkin<vr_um_min01 and checkout is null  and kdijin_absensi is null  then 0
                                    when  checkin<vr_um_min01 and checkout<vr_um_max01 then 0
                                    when  checkin<vr_um_min01 and checkout>=vr_um_max01 and to_char(tgl,'Dy')<>'Sat' then besaran
                                    when  checkin<vr_um_min01 and checkout>=vr_um_max02 and to_char(tgl,'Dy')='Sat' then besaran
                                    when  checkin<vr_um_min01 and checkout is null and kdijin_absensi='IK' and cast(to_char(tc.approval_date,'yyyy-mm-dd')as date)<=vr_date_now  then besaran
                                    when  cast(to_char(tc.approval_date,'yyyy-mm-dd')as date)=ta.tgl  then besaran */

                                        else besaran
                                    end as nominal,
                                case 	when checkin is null and checkout is null and td.nodok is null then 'TIDAK MASUK KANTOR'
                                        when checkin is null and checkout is null and td.nodok is not null then 'DINAS DENGAN NO DINAS :'||td.nodok||'|| APP TGL: '||to_char(td.approval_date,'yyyy-mm-dd')
                                        when checkin<jam_masuk and checkout>jam_pulang and te.nodok is null then 'TEPAT WAKTU'
                                        when checkin<jam_masuk and checkout>jam_pulang and te.nodok is not null then 'TEPAT WAKTU + Lembur :'||te.nodok
                                        when checkin>jam_masuk and checkout<jam_pulang AND tc.nodok is not null then 'IJIN DGN NO :'||tc.nodok||'|| APP TGL: '||to_char(tc.approval_date,'yyyy-mm-dd')
                                        when checkin>jam_masuk and checkout<jam_pulang then 'TELAT MASUK/PULANG AWAL'
                                        when checkin>=jam_masuk and checkout>jam_pulang and tc.kdijin_absensi is null then 'TELAT MASUK'
                                        when checkin>=jam_masuk and checkout>jam_pulang and tc.kdijin_absensi is not null then 'IJIN DGN NO :'||tc.nodok||'|| APP TGL: '||to_char(tc.approval_date,'yyyy-mm-dd')
                                        when checkin isnull and checkout>jam_pulang then 'TIDAK CEKLOG MASUK'
                                        when checkin<jam_masuk and checkout is null and tc.kdijin_absensi is null then 'TIDAK CEKLOG PULANG'
                                        when checkin<jam_masuk and checkout<jam_pulang then 'PULANG AWAL'
                                        when checkin<vr_um_min01  and checkout is null and kdijin_absensi='IK' then 'IJIN DGN NO :'||tc.nodok||'|| APP TGL: '||to_char(tc.approval_date,'yyyy-mm-dd')
                                    end as keterangan,'I' as status from (
                                                                             select vr_branch as branch,a.nik,b.nmlengkap,c.kddept,c.nmdept,e.kdjabatan,e.nmjabatan,a.tgl,
                                                                                    case
                                                                                        when a.jam_masuk_absen=a.jam_pulang_absen and a.jam_masuk_absen>vr_um_max01 then null
                                                                                        else a.jam_masuk_absen end as checkin,
                                                                                    case
                                                                                        when a.jam_masuk_absen=a.jam_pulang_absen and a.jam_pulang_absen<=vr_um_max01 then null
                                                                                        else a.jam_pulang_absen end as checkout,null as nominal,'' as keterangan,b.kdcabang,b.lvl_jabatan,a.jam_masuk,a.jam_pulang,f.besaran as kantin from sc_trx.transready a
                                                                                                                                                                                                                                                left outer join sc_mst.karyawan b on a.nik=b.nik
                                                                                                                                                                                                                                                left outer join sc_mst.departmen c on b.bag_dept=c.kddept
                                                                                                                                                                                                                                                left outer join sc_mst.subdepartmen d on b.subbag_dept=d.kdsubdept and b.bag_dept=d.kddept
                                                                                                                                                                                                                                                left outer join sc_mst.jabatan e on b.jabatan=e.kdjabatan and b.subbag_dept=e.kdsubdept and b.bag_dept=e.kddept
                                                                                                                                                                                                                                                left outer join sc_mst.kantin f on b.kdcabang=f.kdcabang
                                                                         ) as ta
                                                                             left outer join sc_mst.uangmakan tb on tb.kdlvl=ta.lvl_jabatan
                                                                             left outer join sc_trx.ijin_karyawan tc on tc.nik=ta.nik and tc.tgl_kerja=ta.tgl and tc.status='P' and tc.type_ijin='DN' AND kdijin_absensi = (select tcc.kdijin_absensi from (
                                                                                                                                                                                                                                                               select
                                                                                                                                                                                                                                                                   kdijin_absensi,
                                                                                                                                                                                                                                                                   CASE
                                                                                                                                                                                                                                                                       when kdijin_absensi IN ('DT') THEN 1
                                                                                                                                                                                                                                                                       when kdijin_absensi IN ('PA') THEN 2
                                                                                                                                                                                                                                                                       else 3
                                                                                                                                                                                                                                                                       END as sort
                                                                                                                                                                                                                                                               from sc_trx.ijin_karyawan where nik = ta.nik and tgl_kerja = ta.tgl and type_ijin = 'DN'  order by sort asc limit 1
                                                                                                                                                                                                                                                           ) tcc
                        ) --and to_char(tc.approval_date,'yyyy-mm-dd')<=to_char(now(),'yyyy-mm-dd')
                                                                             left outer join sc_trx.dinas td on td.nik=ta.nik and (ta.tgl between td.tgl_mulai and td.tgl_selesai) and td.status='P'
                                                                             left outer join sc_trx.lembur te on te.nik=ta.nik and te.tgl_kerja=ta.tgl and to_char(ta.checkout,'HH23:MI:SS')>='18:00:00' and te.status='P'/*LEMBUR */
                         where ta.lvl_jabatan<>'A' and ta.nik=vr_nik and ta.tgl=vr_tgl
                         group by ta.nik,ta.nmlengkap,ta.tgl,ta.checkin,ta.checkout,ta.kdcabang,ta.jam_masuk,ta.jam_pulang,tb.besaran,ta.lvl_jabatan,ta.kantin,tc.kdijin_absensi,tc.tgl_kerja,td.nodok,td.approval_date,tc.nodok,tc.approval_date,te.nodok
                         ORDER BY NMLENGKAP);
                end if;
            END LOOP;

    END IF;
    RETURN 'MMMUACH :* ';
END;
$function$
;



-- DROP FUNCTION sc_tmp.pr_hitung_rekap_um(bpchar, date, date);

CREATE OR REPLACE FUNCTION sc_tmp.pr_hitung_rekap_um_njrm(vr_kdcabang character, vr_tglawal date, vr_tglakhir date)
 RETURNS SETOF void
 LANGUAGE plpgsql
AS $function$
    --author by : Fiky Ashariza 02-02-2017
--update by : RKM 21-06-2024 :: penyamaan dengan metode nusa dan penambahan kolom(bbm,sewakendaran,rencanacallplan,realisaicallplan)
--update by : RKM 04-01-2025 :: perubahan ketetntuan uang bbm => realisasi callplan > 0
DECLARE vr_tglapproval date;
    DECLARE vr_tgl_act date;
    DECLARE vr_tgl_dok date;
    DECLARE vr_nodok_ref character(12);
    DECLARE vr_nominal_um numeric;
    DECLARE vr_cek_nominal_um numeric;
    DECLARE vr_nik character(12);

--DECLARE vr_out integer;


BEGIN
    --select * from sc_mst.kantin
    --select * from sc_mst.uangmakan_njrm
    --select * from sc_mst.karyawan where nmlengkap like '%TINO%'
    FOR vr_nik in select trim(nik) from sc_mst.karyawan where tglkeluarkerja is null and kdcabang=vr_kdcabang
        LOOP
            vr_nominal_um:=case
                               when a.kdcabang='SMGDMK' then b.besaran-c.besaran
                               else b.besaran
                               end as nominal from sc_mst.karyawan a left outer join
                                                   sc_mst.uangmakan_njrm b on a.lvl_jabatan=b.kdlvl left outer join
                                                   sc_mst.kantin c on a.kdcabang=c.kdcabang
                           where a.nik=vr_nik;

            for vr_nodok_ref in select trim(dok_ref) from sc_trx.uangmakan
                                where nik=vr_nik and dok_ref is not null and (left(dok_ref,2)='IK' or left(dok_ref,2)='PA' or left(dok_ref,2)='DT') and
                                    (to_char(tgl,'yyyy-mm-dd') between to_char(vr_tglawal - interval'1 week','yyyy-mm-dd') and to_char(vr_tglakhir,'yyyy-mm-dd'))
                loop
                    select cast(to_char(approval_date,'yyyy-mm-dd')as date) into vr_tglapproval from sc_trx.ijin_karyawan where nodok=vr_nodok_ref;
                    select nominal into vr_cek_nominal_um from sc_trx.uangmakan where dok_ref=vr_nodok_ref and nik=vr_nik;

                    IF (vr_cek_nominal_um=0 or vr_cek_nominal_um is null) THEN
                        update sc_trx.uangmakan set nominal=vr_nominal_um,keterangan='+ PERSETUJUAN NO IJIN : '||vr_nodok_ref where tgl=vr_tglapproval and nik=vr_nik;
                    END IF;

                    return next vr_nodok_ref;
                end loop;

            return next vr_nik;
        end loop;

    UPDATE sc_trx.uangmakan AS a
    SET
        rencanacallplan = x.rencanacallplan,
        realisasicallplan = x.realisasicallplan,
        nominal = x.nominal,
        keterangan = x.keterangan,
        bbm = CASE
	          WHEN x.tbbm = 'T' THEN
	              CASE
	                  WHEN x.checkin IS NOT NULL THEN
	                      CASE
	                          WHEN callplan = 't' THEN
	                              CASE
	                                  WHEN x.rencanacallplan > 0 THEN
	                                      CASE
	                                          WHEN x.realisasicallplan > 0 THEN
	                                              CASE
	                                                  WHEN nodok IS NOT NULL AND type_ijin = 'DN' AND kendaraan = 'PRIBADI' THEN y.nominal
	                                                  WHEN x.keterangan NOT SIMILAR TO '(DINAS|CUTI)%' THEN y.nominal
	                                                  ELSE 0
	                                              END
	                                          ELSE 0
	                                      END
	                                  ELSE
	                                      0
	                              END
	                          ELSE
	                              CASE
	                                  WHEN nodok IS NOT NULL AND type_ijin = 'DN' AND kendaraan = 'PRIBADI' THEN y.nominal
	                                  WHEN x.keterangan NOT SIMILAR TO '(DINAS|CUTI)%' THEN y.nominal
	                                  ELSE 0
	                              END
	                      END
	                  ELSE 0
	              END
	          ELSE 0
	      END,
        sewa_kendaraan = CASE
                             WHEN x.tsewa = 'T' THEN
                                 case
                                     when x.checkin is not null THEN
                                         CASE
                                             WHEN nodok is not null AND type_ijin = 'DN' AND kendaraan = 'PRIBADI' THEN z.nominal
                                             WHEN x.checkin is not null AND x.keterangan NOT SIMILAR TO '(DINAS|CUTI)%' THEN z.nominal
                                             ELSE 0
                                             END
                                     else 0
                                     END
                             ELSE 0
            END
    FROM (
             SELECT
                 a.nik,
                 a.tgl,
                 d.jumlah AS rencanacallplan,
                 e.jumlah AS realisasicallplan,
                 a.checkin,
                 a.checkout,
                 EXTRACT(HOUR FROM (a.checkout - a.checkin)) AS worktime,
                 j.total AS nominal,
                 CASE
                    WHEN b.callplan = 't' THEN
                        CASE
                             WHEN (a.dok_ref IS NOT NULL AND h.kdijin_absensi = 'IK' AND h.type_ijin = 'DN' AND h.status = 'P' AND a.keterangan SIMILAR TO 'TEPAT WAKTU' AND e.jumlah < d.jumlah AND d.jumlah > 0 ) THEN j.keterangan || ' + IJIN DENGAN NO. '||a.dok_ref || ' + CALLPLAN TIDAK TERPENUHI'
                             WHEN (a.dok_ref IS NOT NULL AND h.kdijin_absensi = 'IK' AND h.type_ijin = 'DN' AND h.status = 'P' AND h.tgl_jam_mulai <= f.jam_masuk AND h.tgl_jam_selesai >= jam_pulang)
                                 OR (a.dok_ref IS NOT NULL AND h.kdijin_absensi NOT IN ('IK', 'DT', 'PA'))
                                 OR (a.checkin IS NULL AND a.checkout IS NULL) OR a.keterangan SIMILAR TO '(DINAS|CUTI)%' THEN SPLIT_PART(j.keterangan, ' + ', 1)
                             WHEN d.jumlah = 0 AND b.callplan = 't' THEN SPLIT_PART(j.keterangan, ' + ', 1) || ' + TIDAK ADA RENCANA CALLPLAN'
                             WHEN d.jumlah = 0 THEN SPLIT_PART(j.keterangan, ' + ', 1)
                             WHEN e.jumlah >= d.jumlah THEN SPLIT_PART(j.keterangan, ' + ', 1) || ' + CALLPLAN TERPENUHI'
                             ELSE SPLIT_PART(j.keterangan, ' + ', 1) || ' + CALLPLAN TIDAK TERPENUHI'
                             END
                    ELSE
                        CASE
                             WHEN (a.dok_ref IS NOT NULL AND h.kdijin_absensi = 'IK' AND h.type_ijin = 'DN' AND h.status = 'P' AND a.keterangan SIMILAR TO 'TEPAT WAKTU' AND e.jumlah < d.jumlah AND d.jumlah > 0 ) THEN j.keterangan || ' + IJIN DENGAN NO. '||a.dok_ref
                             WHEN (a.dok_ref IS NOT NULL AND h.kdijin_absensi = 'IK' AND h.type_ijin = 'DN' AND h.status = 'P' AND h.tgl_jam_mulai <= f.jam_masuk AND h.tgl_jam_selesai >= jam_pulang)
                                 OR (a.dok_ref IS NOT NULL AND h.kdijin_absensi NOT IN ('IK', 'DT', 'PA'))
                                 OR (a.checkin IS NULL AND a.checkout IS NULL) OR a.keterangan SIMILAR TO '(DINAS|CUTI)%' THEN SPLIT_PART(j.keterangan, ' + ', 1)
                             WHEN d.jumlah = 0 AND b.callplan = 't' THEN SPLIT_PART(j.keterangan, ' + ', 1)
                             WHEN d.jumlah = 0 THEN SPLIT_PART(j.keterangan, ' + ', 1)
                             WHEN e.jumlah >= d.jumlah THEN SPLIT_PART(j.keterangan, ' + ', 1)
                             ELSE SPLIT_PART(j.keterangan, ' + ', 1)
                             END
                    END AS keterangan,
                 h.nodok,
                 h.type_ijin,
                 h.kendaraan,
                 COALESCE(TRIM(i.sewakendaraan),'') AS tsewa,
                 COALESCE(TRIM(i.bbm),'') AS tbbm,
                 jam_masuk,
                 jam_pulang,
                 jam_pulang_min,
                 jam_masuk_max,
                 c.kdregu,
                 b.callplan
             FROM sc_trx.uangmakan a
                      LEFT OUTER JOIN sc_mst.karyawan b ON b.nik = a.nik AND b.tglkeluarkerja IS NULL AND b.kdcabang = vr_kdcabang
                      left OUTER JOIN sc_mst.jabatan i ON b.bag_dept = i.kddept AND b.subbag_dept = i.kdsubdept AND b.jabatan = i.kdjabatan
                      LEFT OUTER JOIN sc_mst.regu_opr c ON c.nik = b.nik
                      LEFT JOIN LATERAL (
                 SELECT COUNT(x.custcode) AS jumlah
                 FROM (
                          SELECT COALESCE(NULLIF(TRIM(xa.locationid), ''), NULLIF(TRIM(xa.locationidlocal), '')) AS custcode
                          FROM sc_tmp.scheduletolocation xa
                          WHERE xa.nik = a.nik AND xa.scheduledate = a.tgl
                          GROUP BY 1
                      ) x
                 ) d ON TRUE
                      LEFT JOIN LATERAL (
                 SELECT COUNT(x.custcode) AS jumlah
                 FROM (
                          SELECT COALESCE(NULLIF(TRIM(xa.customeroutletcode), ''), NULLIF(TRIM(xa.customercodelocal), '')) AS custcode
                          FROM sc_tmp.checkinout xa
                          WHERE xa.checktime::DATE = a.tgl
                            AND xa.nik = a.nik
                            --AND xa.customertype = 'C'
                            AND COALESCE(NULLIF(TRIM(xa.customeroutletcode), ''), NULLIF(TRIM(xa.customercodelocal), '')) IN (
                              SELECT COALESCE(NULLIF(TRIM(xa.locationid), ''), NULLIF(TRIM(xa.locationidlocal), '')) AS custcode
                              FROM sc_tmp.scheduletolocation xa
                              WHERE xa.nik = a.nik AND xa.scheduledate = a.tgl
                              GROUP BY 1
                          )
                          GROUP BY 1
                      ) x
                 ) e ON TRUE
                      LEFT JOIN LATERAL (
                 SELECT jam_masuk, jam_pulang, jam_masuk_max, jam_pulang_min
                 FROM sc_mst.jam_kerja
                 WHERE kdjam_kerja = CASE
                                         WHEN EXTRACT(DOW FROM a.tgl) IN (1, 2, 3, 4) AND c.kdregu = 'SL' THEN 'SL1'
                                         WHEN EXTRACT(DOW FROM a.tgl) IN (5) AND c.kdregu = 'SL' THEN 'SL2'
                                         WHEN EXTRACT(DOW FROM a.tgl) IN (6) AND c.kdregu = 'SL' THEN 'SL3'
                                         WHEN EXTRACT(DOW FROM a.tgl) IN (1, 2, 3, 4) AND c.kdregu = 'NC' THEN 'NC1'
                                         WHEN EXTRACT(DOW FROM a.tgl) IN (5) AND c.kdregu = 'NC' THEN 'NC2'
                                         WHEN EXTRACT(DOW FROM a.tgl) IN (6) AND c.kdregu = 'NC' THEN 'NC3'
                                         WHEN EXTRACT(DOW FROM a.tgl) IN (1, 2, 3, 4) THEN 'NSA'
                                         WHEN EXTRACT(DOW FROM a.tgl) IN (5) THEN 'NSB'
                                         WHEN EXTRACT(DOW FROM a.tgl) IN (6) THEN 'NSC'
                     END
                 ) f ON TRUE
                      LEFT JOIN LATERAL (
                 SELECT
                     CASE
                         WHEN b.kdcabang = 'SMGDMK' THEN
                             CASE
                                 WHEN (c.kdregu = 'SL' OR b.callplan = 't') THEN xa.besaran
                                 ELSE xa.besaran - xb.besaran
                                 END
                         ELSE xa.besaran
                         END AS nominal
                 FROM sc_mst.uangmakan_njrm xa
                          LEFT JOIN sc_mst.kantin xb ON xb.kdcabang = b.kdcabang
                 WHERE xa.kdlvl = b.lvl_jabatan
                 ) g ON TRUE
                      LEFT JOIN sc_trx.ijin_karyawan h ON h.nodok = a.dok_ref AND h.status = 'P'
                      LEFT JOIN sc_trx.master_um j ON a.nik = j.nik AND a.tgl = j.tgl
             WHERE a.tgl::DATE BETWEEN vr_tglawal AND vr_tglakhir
             ORDER BY b.kdcabang, b.nmlengkap, a.tgl
         ) AS x
             LEFT JOIN LATERAL (
        SELECT value3 as nominal from sc_mst.option where kdoption = 'UB'
        ) y ON TRUE
             LEFT JOIN LATERAL (
        SELECT value3 as nominal from sc_mst.option where kdoption = 'USK'
        ) z ON TRUE
    WHERE a.nik = x.nik AND a.tgl = x.tgl;


END
$function$
;


select * from sc_mst.regu_opr

alter table sc_mst.regu_opr 
ALTER COLUMN nik TYPE VARCHAR(20);


INSERT INTO "sc_tmp"."karyawan" ("branch", "nik", "nmlengkap", "callname", "jk", "neglahir", "provlahir", "kotalahir", "tgllahir", "kd_agama", "stswn", "stsfisik", "ketfisik", "noktp", "tgl_ktp", "ktp_seumurhdp", "ktpdikeluarkan", "tgldikeluarkan", "status_pernikahan", "gol_darah", "negktp", "provktp", "kotaktp", "kecktp", "kelktp", "alamatktp", "negtinggal", "provtinggal", "kotatinggal", "kectinggal", "keltinggal", "alamattinggal", "nohp1", "nohp2", "npwp", "tglnpwp", "bag_dept", "subbag_dept", "jabatan", "lvl_jabatan", "kdgradejabatan", "grade_golongan", "nik_atasan", "nik_atasan2", "status_ptkp", "besaranptkp", "tglmasukkerja", "masakerja", "grouppenggajian", "gajipokok", "gajibpjs", "gajinaker", "namabank", "namapemilikrekening", "norek", "idabsen", "idmesin", "cardnumber", "email", "inputdate", "inputby", "tjborong", "tjshift", "tjlembur", "kdcabang", "nokk", "kdwilayahnominal", "kdlvlgp", "callplan", "idbu") VALUES ( E'SBYNSA', E'1020.406', E'NURMA RAHAYU', E'NURMA', E'P', E'IDN', E'35', E'3525 ', E'20-04-1998', E'ISL', E'T', E'T', E'-', E'3515022004980003', NULL, E'T', E'GRESIK', E'06-06-2016', E'TK', E'A', E'IDN', E'35', E'3525 ', E'3525020 ', E'3525020004 ', E'JL. RAYA BAMBE NO.35, KECAMATAN DRIYOREJO KABUPATEN GRESIK, DESA BAMBE. KODEPOS 61177', E'IDN', E'35', E'3525 ', E'3525020 ', E'3525020004 ', E'JL. RAYA BAMBE NO.35, KECAMATAN DRIYOREJO KABUPATEN GRESIK, DESA BAMBE. KODEPOS 61177', E'08792718593', E'-', E'81.374.346.5-000.000', E'30-06-2021', E'FI ', E'FD ', E'FIN05 ', E'D ', '', E'STAF1 ', E'0214.127', E'0312.066', E'K0', E'58500000', E'10-12-2025', '', E'P1', NULL, NULL, NULL, E'MDR', E'NURMA RAHAYU', '', E'09.0244.011', E'1', E'09.0244.011', E'NURMA.RAHAYU@GMAIL.COM', E'30-12-2025 17:55:19', E'1020.406', E'f', E'f', E'f', E'SBYMRG', E'3172010502090982', E'SBY.0004', '', E'f', E'F')

select * from sc_mst.trxerror

alter table sc_mst.trxerror
add COLUMN error_detail text;


select * from sc_mst.trxerror

select * from sc_mst.karyawan where nmlengkap like '%NURMA%'

select * from sc_mst.kantorwilayah


INSERT INTO "sc_tmp"."karyawan" ("branch", "nik", "nmlengkap", "callname", "jk", "neglahir", "provlahir", "kotalahir", "tgllahir", "kd_agama", "stswn", "stsfisik", "ketfisik", "noktp", "tgl_ktp", "ktp_seumurhdp", "ktpdikeluarkan", "tgldikeluarkan", "status_pernikahan", "gol_darah", "negktp", "provktp", "kotaktp", "kecktp", "kelktp", "alamatktp", "negtinggal", "provtinggal", "kotatinggal", "kectinggal", "keltinggal", "alamattinggal", "nohp1", "nohp2", "npwp", "tglnpwp", "bag_dept", "subbag_dept", "jabatan", "lvl_jabatan", "kdgradejabatan", "grade_golongan", "nik_atasan", "nik_atasan2", "status_ptkp", "besaranptkp", "tglmasukkerja", "masakerja", "grouppenggajian", "gajipokok", "gajibpjs", "gajinaker", "namabank", "namapemilikrekening", "norek", "idabsen", "idmesin", "cardnumber", "email", "inputdate", "inputby", "tjborong", "tjshift", "tjlembur", "kdcabang", "nokk", "kdwilayahnominal", "kdlvlgp", "callplan", "idbu") VALUES ( E'SBYNSA', E'1020.406', E'NURMA RAHAYU', E'NURMA', E'P', E'IDN', E'35', E'3525 ', E'20-04-1998', E'ISL', E'T', E'T', E'-', E'3515022004980003', NULL, E'T', E'GRESIK', E'06-06-2016', E'TK', E'A', E'IDN', E'35', E'3525 ', E'3525020 ', E'3525020004 ', E'JL. RAYA BAMBE NO.35, KECAMATAN DRIYOREJO KABUPATEN GRESIK, DESA BAMBE. KODEPOS 61177', E'IDN', E'35', E'3525 ', E'3525020 ', E'3525020004 ', E'JL. RAYA BAMBE NO.35, KECAMATAN DRIYOREJO KABUPATEN GRESIK, DESA BAMBE. KODEPOS 61177', E'08792718593', E'-', E'81.374.346.5-000.000', E'30-06-2021', E'FI ', E'FD ', E'FIN05 ', E'D ', '', E'STAF1 ', E'0214.127', E'0312.066', E'K0', E'58500000', E'10-12-2025', '', E'P1', NULL, NULL, NULL, E'MDR', E'NURMA RAHAYU', '', E'09.0244.011', E'1', E'09.0244.011', E'NURMA.RAHAYU@GMAIL.COM', E'30-12-2025 18:22:31', E'1020.406', E'f', E'f', E'f', E'SBYMRG', E'3172010502090982', E'SBY.0004', '', E'f', E'F')


select * from sc_mst.kantorwilayah order by desc_cabang asc


select * from sc_mst.idbu